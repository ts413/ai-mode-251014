# Story 2.4: 노트 삭제 (즉시 삭제)

## Status

Done

## Story

**As a** 로그인한 사용자,
**I want** 더 이상 필요하지 않은 노트를 안전하게 삭제할 수 있는 기능,
**so that** 불필요한 노트를 정리하고 깔끔한 노트 목록을 유지할 수 있다.

## Acceptance Criteria

1. 노트 목록에서 각 노트에 삭제 버튼이 표시되어야 한다
2. 노트 상세 페이지에서도 삭제 버튼이 표시되어야 한다
3. 삭제 버튼 클릭 시 확인 다이얼로그가 표시되어야 한다
4. 확인 다이얼로그에는 노트 제목이 표시되어 실수 방지해야 한다
5. 삭제 확인 시 노트가 즉시 데이터베이스에서 삭제되어야 한다
6. 삭제 후 적절한 페이지로 리다이렉트되어야 한다 (목록 또는 홈)
7. 삭제 중 로딩 상태가 표시되어야 한다
8. 삭제 실패 시 에러 메시지가 표시되어야 한다
9. 다른 사용자의 노트는 삭제할 수 없어야 한다 (권한 검증)
10. 키보드 접근성을 지원해야 한다 (ESC로 다이얼로그 닫기)

## Tasks / Subtasks

-   [x] 노트 삭제 Server Action 구현 (AC: 5, 8, 9)
    -   [x] deleteNote 함수 구현
    -   [x] 권한 검증 로직 추가
    -   [x] 에러 핸들링 및 응답 처리
    -   [x] 캐시 무효화 처리
-   [x] 삭제 확인 다이얼로그 컴포넌트 구현 (AC: 3, 4, 10)
    -   [x] 모달 다이얼로그 UI 구현
    -   [x] 노트 제목 표시 기능
    -   [x] 키보드 접근성 지원 (ESC 키)
    -   [x] 확인/취소 버튼 구현
-   [x] 노트 목록 삭제 기능 통합 (AC: 1, 6, 7)
    -   [x] 노트 카드에 삭제 버튼 추가 (hover 시 표시)
    -   [x] 삭제 중 로딩 상태 표시
    -   [x] 낙관적 업데이트 구현
    -   [x] 에러 복구 메커니즘
-   [x] 노트 상세 페이지 삭제 기능 통합 (AC: 2, 6, 7)
    -   [x] 상세 페이지에 삭제 버튼 추가
    -   [x] 삭제 후 목록 페이지로 리다이렉트
    -   [x] 로딩 상태 처리

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **UI:** shadcn/ui + Tailwind + Radix UI
-   **DB/ORM:** Drizzle ORM + Supabase (PostgreSQL)
-   **상태 관리:** React useState/useEffect (클라이언트 상태)

### 삭제 확인 다이얼로그 설계

**UI/UX 고려사항:**

```typescript
interface DeleteConfirmDialogProps {
    isOpen: boolean
    noteTitle: string
    onConfirm: () => void
    onCancel: () => void
    isLoading?: boolean
}
```

**다이얼로그 내용:**

-   **제목**: "노트 삭제"
-   **내용**: "'[노트 제목]'을(를) 정말 삭제하시겠습니까?"
-   **부제**: "삭제된 노트는 복구할 수 없습니다."
-   **버튼**: 취소 (기본 포커스) + 삭제 (위험 스타일)

### Server Action 설계

```typescript
export async function deleteNote(noteId: string): Promise<{
    success: boolean
    error?: string
}> {
    // 1. 사용자 인증 확인
    // 2. 노트 소유자 확인
    // 3. 노트 삭제 실행
    // 4. 캐시 무효화
    // 5. 결과 반환
}
```

**에러 처리:**

-   **401**: 인증되지 않은 사용자
-   **403**: 노트 소유자가 아님
-   **404**: 노트를 찾을 수 없음
-   **500**: 서버 오류

### 낙관적 업데이트 전략

**노트 목록에서의 삭제:**

1. 즉시 UI에서 노트 카드 제거 (fade-out 애니메이션)
2. 백그라운드에서 삭제 API 호출
3. 실패 시 노트 카드 복원 + 에러 메시지 표시

```typescript
const handleDelete = async (noteId: string) => {
    // 낙관적 업데이트: UI에서 즉시 제거
    const optimisticNotes = notes.filter(note => note.id !== noteId)
    setNotes(optimisticNotes)

    try {
        const result = await deleteNote(noteId)
        if (!result.success) {
            // 실패 시 복원
            setNotes(originalNotes)
            showError(result.error)
        }
    } catch (error) {
        // 에러 시 복원
        setNotes(originalNotes)
        showError('삭제 중 오류가 발생했습니다')
    }
}
```

### 접근성 고려사항

-   **포커스 관리**: 다이얼로그 열릴 때 첫 번째 버튼에 포커스
-   **키보드 네비게이션**: Tab으로 버튼 간 이동
-   **스크린 리더**: 삭제 위험성 명확히 전달
-   **색상 대비**: 삭제 버튼이 WCAG 2.1 AA 준수

### 보안 고려사항

-   **CSRF 방지**: Next.js Server Actions 자동 보호
-   **권한 검증**: 모든 삭제 요청에서 소유자 확인
-   **입력 검증**: noteId 형식 검증
-   **SQL 인젝션 방지**: Drizzle ORM 자동 보호

### 성능 최적화

-   **낙관적 업데이트**: 즉각적인 UI 반응
-   **캐시 무효화**: 필요한 경로만 선택적 무효화
-   **애니메이션**: CSS transitions로 부드러운 삭제 효과

### 재사용 가능한 컴포넌트

-   `components/notes/delete-confirm-dialog.tsx` - 삭제 확인 다이얼로그 (새로 추가)
-   `components/notes/delete-note-button.tsx` - 삭제 버튼 컴포넌트 (새로 추가)
-   `components/ui/alert-dialog.tsx` - 기본 알림 다이얼로그 (shadcn/ui 활용)

### 에러 처리 전략

**클라이언트 에러:**

-   네트워크 오류 시 재시도 옵션 제공
-   사용자에게 명확한 에러 메시지 표시
-   실패한 삭제 작업 복원

**서버 에러:**

-   403: 권한 없음 → 에러 메시지 + 목록으로 리다이렉트
-   404: 노트 없음 → "이미 삭제된 노트입니다" 메시지
-   500: 서버 오류 → 재시도 버튼 제공

### 사용자 경험 최적화

**삭제 플로우:**

1. 삭제 버튼 클릭 → 확인 다이얼로그 표시
2. 확인 클릭 → 로딩 스피너 + 낙관적 UI 업데이트
3. 완료 → 성공 피드백 (선택적 토스트)
4. 실패 → 원상 복구 + 에러 메시지

**위험 요소 강조:**

-   삭제 버튼을 빨간색으로 스타일링
-   "복구할 수 없음" 경고 메시지
-   실수 방지를 위한 이중 확인

### URL 상태 관리

**삭제 후 네비게이션:**

-   **노트 목록에서 삭제**: 현재 페이지 유지
-   **노트 상세에서 삭제**: `/notes` 목록으로 리다이렉트
-   **마지막 노트 삭제**: 빈 상태 페이지 표시

### Testing

#### 단위 테스트

-   deleteNote Server Action 테스트
-   권한 검증 로직 테스트
-   에러 처리 시나리오 테스트

#### 통합 테스트

-   노트 목록 → 삭제 → 목록 업데이트 플로우
-   노트 상세 → 삭제 → 리다이렉트 플로우
-   권한 없는 삭제 시도 테스트

#### E2E 테스트

-   전체 삭제 플로우 테스트
-   키보드 접근성 테스트
-   에러 시나리오 테스트

### 프로젝트 구조

**새로 추가될 파일:**

-   `components/notes/delete-confirm-dialog.tsx` - 삭제 확인 다이얼로그
-   `components/notes/delete-note-button.tsx` - 삭제 버튼 컴포넌트
-   `lib/notes/hooks/useDeleteNote.ts` - 삭제 관련 커스텀 훅

**수정될 파일:**

-   `lib/notes/actions.ts` - deleteNote Server Action 추가
-   `components/notes/note-form.tsx` - 노트 카드에 삭제 버튼 추가
-   `components/notes/note-editor.tsx` - 상세 페이지에 삭제 버튼 추가
-   `app/notes/page.tsx` - 목록 페이지 삭제 기능 통합

## Change Log

| Date       | Version | Description      | Author                    |
| ---------- | ------- | ---------------- | ------------------------- |
| 2025-09-14 | 1.0     | 스토리 생성      | Dev Agent Claude 4 Sonnet |
| 2025-09-14 | 2.0     | 스토리 구현 완료 | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude 4 Sonnet

### Debug Log References

-   성공적으로 모든 Acceptance Criteria 구현 완료
-   안전한 삭제 프로세스 구현 (확인 다이얼로그 + 권한 검증)
-   낙관적 업데이트로 즉각적인 UI 반응 제공
-   접근성 고려사항 적용 (키보드 네비게이션, 스크린 리더 지원)
-   에러 처리 및 복구 메커니즘 구현

### Completion Notes List

1. ✅ **삭제 확인 다이얼로그**: 실수 방지를 위한 이중 확인 프로세스
2. ✅ **안전한 삭제**: 권한 검증 및 소유자 확인
3. ✅ **낙관적 업데이트**: 즉시 UI 반영으로 부드러운 사용자 경험
4. ✅ **접근성**: ESC 키, 포커스 관리, 스크린 리더 지원
5. ✅ **에러 처리**: 네트워크 오류 시 자동 복구 및 에러 표시
6. ✅ **반응형 디자인**: 모바일/데스크톱 환경 모두 지원
7. ✅ **컴포넌트 재사용성**: 목록/상세 페이지에서 동일한 컴포넌트 활용
8. ✅ **상태 관리**: 로딩 상태, 에러 상태 완벽 처리
9. ✅ **시각적 피드백**: hover 효과, 로딩 스피너, 위험 색상 적용
10. ✅ **캐시 관리**: revalidatePath로 일관된 데이터 상태 유지

### File List

**새로 생성된 파일:**

-   `components/notes/delete-confirm-dialog.tsx` - 삭제 확인 다이얼로그
-   `components/notes/delete-note-button.tsx` - 재사용 가능한 삭제 버튼
-   `components/notes/note-card.tsx` - 개별 노트 카드 컴포넌트
-   `components/notes/notes-list.tsx` - 낙관적 업데이트를 위한 목록 컴포넌트

**수정된 파일:**

-   `lib/notes/actions.ts` - deleteNote Server Action 추가
-   `app/notes/page.tsx` - NotesList 컴포넌트로 교체
-   `components/notes/note-editor.tsx` - 상세 페이지에 삭제 버튼 추가

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
