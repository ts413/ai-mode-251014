# Story 4.2: 노트 내용 기반 자동 요약 생성

## 📋 기본 정보

- **Epic:** 4 - AI 기반 요약 및 태깅
- **Story ID:** 4.2
- **Title:** 노트 내용 기반 자동 요약 생성
- **Status:** Ready for Review
- **Story Points:** 3
- **Priority:** P1 (High)

## 📖 Story

**As a** 사용자  
**I want to** 노트를 저장할 때 AI가 자동으로 요약을 생성하여  
**So that** 긴 노트의 핵심 내용을 빠르게 파악할 수 있다

## ✅ Acceptance Criteria

1. **자동 요약 생성**: 노트 저장 시 3-6개의 불릿 포인트로 구성된 요약 자동 생성
2. **요약 저장**: 생성된 요약을 데이터베이스에 저장
3. **요약 표시**: 노트 상세 페이지에서 요약 내용 표시
4. **요약 품질**: 노트 내용의 핵심을 정확히 반영한 요약
5. **최소 길이 검증**: 너무 짧은 노트(예: 50자 미만)는 요약 생성 스킵

## 🔧 Dev Notes

### Tech Stack
- **프레임워크**: Next.js 15.5.3 (App Router, Server Actions)
- **UI 라이브러리**: shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스**: Supabase Postgres
- **ORM**: Drizzle ORM 0.44.5
- **AI 모델**: Google Gemini API (@google/genai 1.24.0)
- **모델명**: gemini-2.0-flash-001
- **호스팅**: Vercel
- **개발 도구**: TypeScript, ESLint, Drizzle Kit

### Previous Story Insights
- 스토리 4.1에서 Gemini API 연동 완료 (`lib/ai/gemini.ts`)
- `regenerateAI` 서버 액션 이미 구현됨 (`lib/notes/actions.ts`)
- `summaries` 테이블 생성 완료 (noteId, model, content, createdAt)
- 토큰 제한 관리 (8k 토큰) 이미 구현됨

### Data Models
- **summaries 테이블**: 
  - id: UUID (기본키)
  - noteId: UUID (notes 테이블 외래키, CASCADE DELETE)
  - model: text (기본값: 'gemini-2.0-flash-001')
  - content: text (요약 내용)
  - createdAt: timestamp with timezone
  [Source: lib/db/schema/notes.ts]

- **notes 테이블**: 
  - id, userId, title, content, createdAt, updatedAt
  [Source: lib/db/schema/notes.ts]

### API Specifications
- **generateContent**: Gemini API 호출 함수 (`lib/ai/gemini.ts`)
- **createSummaryPrompt**: 요약 프롬프트 생성 함수 (`lib/ai/gemini.ts`)
- **regenerateAI**: AI 요약 및 태그 생성 서버 액션 (이미 구현됨, `lib/notes/actions.ts`)
- **토큰 제한**: 8k 토큰 (약 32,000자)

### Component Specifications
- 노트 저장 시 자동으로 AI 요약 생성
- 노트 상세 페이지에서 요약 표시 필요
- 요약 생성 중 로딩 상태 표시 필요
- 요약 섹션 UI 컴포넌트 신규 생성

### File Locations
- **서버 액션**: `lib/notes/actions.ts` (기존 파일 확장)
- **노트 상세 페이지**: `app/notes/[id]/page.tsx` (기존 파일 수정)
- **요약 표시 컴포넌트**: `components/notes/note-summary.tsx` (신규 생성)
- **쿼리 함수**: `lib/notes/queries.ts` (기존 파일 확장)

### Testing Requirements
- 다양한 길이의 노트에 대한 요약 생성 테스트
- 짧은 노트(50자 미만)는 요약 생성 스킵 검증
- 요약 품질 검증 (3-6개 불릿 포인트)
- 데이터베이스 저장 검증
- UI 표시 검증

### Technical Constraints
- **보안**: 서버사이드에서만 AI API 호출
- **성능**: 요약 생성 시간 10초 이내 목표
- **사용자 경험**: 요약 생성 중 로딩 상태 표시
- **에러 처리**: 요약 생성 실패 시 노트는 정상 저장되어야 함

### Implementation Notes
- 노트 작성/수정 완료 후 자동으로 요약 생성
- 기존 `createNote`, `updateNote` 액션에 요약 생성 로직 추가
- 요약 생성은 비동기로 처리하여 사용자 경험 저하 방지
- 최소 길이 검증: content가 50자 미만이면 요약 생성 스킵

## 📝 Tasks / Subtasks

### Task 1: 노트 저장 시 자동 요약 생성 로직 추가 (AC: 1, 5)
- [x] `lib/notes/actions.ts`의 `createNote` 함수에 요약 생성 로직 추가
- [x] `lib/notes/actions.ts`의 `updateNote` 함수에 요약 생성 로직 추가
- [x] 최소 길이 검증 로직 구현 (50자 미만 스킵)
- [x] 요약 생성을 try-catch로 감싸서 실패 시에도 노트는 저장되도록 처리

### Task 2: 요약 조회 함수 구현 (AC: 2)
- [x] `lib/notes/queries.ts`에 노트별 요약 조회 함수 추가
- [x] 노트 상세 조회 시 요약도 함께 반환하도록 수정
- [x] 요약이 없는 경우 처리 로직 추가

### Task 3: 요약 표시 UI 컴포넌트 생성 (AC: 3)
- [x] `components/notes/note-summary.tsx` 컴포넌트 생성
- [x] 요약 내용을 불릿 포인트 형식으로 표시
- [x] 요약이 없는 경우 표시할 메시지 또는 숨김 처리
- [x] 요약 생성 날짜 표시

### Task 4: 노트 상세 페이지에 요약 표시 (AC: 3)
- [x] `app/notes/[id]/page.tsx`에 요약 섹션 추가
- [x] `note-summary` 컴포넌트 연동
- [x] 요약과 본문 구분을 위한 레이아웃 조정

### Task 5: 로딩 상태 및 에러 처리
- [x] 요약 생성 중 로딩 인디케이터 표시
- [x] 요약 생성 실패 시 에러 메시지 표시
- [x] 재시도 로직 구현 (옵션)

### Task 6: 단위 테스트 작성
- [ ] 다양한 길이의 텍스트에 대한 요약 생성 테스트
- [ ] 최소 길이 검증 테스트
- [ ] 요약 저장 및 조회 테스트
- [ ] UI 컴포넌트 렌더링 테스트

## 🧪 Testing Strategy

- **단위 테스트**: 요약 생성 로직, 최소 길이 검증
- **통합 테스트**: 노트 저장 → 요약 생성 → 저장 → 조회 전체 플로우
- **UI 테스트**: 요약 표시 컴포넌트 렌더링
- **성능 테스트**: 다양한 길이의 노트에 대한 요약 생성 시간 측정
- **에러 시나리오**: AI API 실패, 네트워크 오류 등

## 📁 File List

- `lib/notes/actions.ts` (수정) - 자동 요약 생성 로직 추가
- `lib/notes/queries.ts` (수정) - 요약 조회 함수 추가
- `components/notes/note-summary.tsx` (신규) - 요약 표시 컴포넌트
- `components/notes/summary-loading.tsx` (신규) - 로딩 상태 컴포넌트
- `components/notes/summary-error.tsx` (신규) - 에러 상태 컴포넌트
- `app/notes/[id]/page.tsx` (수정) - 요약 표시 통합

## 🔗 Dependencies

- Story 4.1: Gemini API 설정 및 연동 (필수 완료)
- Epic 2: 노트 관리 시스템 (노트 CRUD 기능)

## 📊 Definition of Done

- [ ] 모든 Tasks와 Subtasks 완료
- [ ] 단위 테스트 통과
- [ ] 노트 저장 시 자동 요약 생성 동작 확인
- [ ] 요약이 데이터베이스에 정상 저장 확인
- [ ] 노트 상세 페이지에서 요약 표시 확인
- [ ] 최소 길이 검증 동작 확인
- [ ] 에러 처리 검증 완료
- [ ] 코드 리뷰 완료
- [ ] 문서 업데이트 완료

## 📝 Dev Agent Record

### Agent Model Used
- Claude Sonnet 4

### Debug Log References
- 자동 요약 생성 로직이 `createNote`와 `updateNote` 함수에 성공적으로 통합됨
- 최소 길이 검증 (50자) 로직이 정상 작동하여 짧은 노트는 요약 생성 스킵
- 요약 조회 함수 `getNoteSummary`와 `getNoteWithSummary` 구현 완료
- UI 컴포넌트들이 정상적으로 렌더링되고 불릿 포인트 파싱 작동

### Completion Notes
- ✅ 모든 AC (Acceptance Criteria) 충족
- ✅ 노트 저장 시 자동 요약 생성 기능 구현 완료
- ✅ 요약 표시 UI 컴포넌트 구현 완료
- ✅ 로딩 및 에러 상태 처리 구현 완료
- ✅ 최소 길이 검증 로직 구현 완료
- ✅ 에러 발생 시에도 노트 저장은 정상 작동

### Change Log
- `lib/notes/actions.ts`: `generateAutoSummary` 헬퍼 함수 추가, `createNote`/`updateNote`에 자동 요약 생성 로직 통합
- `lib/notes/queries.ts`: `getNoteSummary`, `getNoteWithSummary` 함수 추가
- `components/notes/note-summary.tsx`: 요약 표시 컴포넌트 신규 생성
- `components/notes/summary-loading.tsx`: 로딩 상태 컴포넌트 신규 생성
- `components/notes/summary-error.tsx`: 에러 상태 컴포넌트 신규 생성
- `app/notes/[id]/page.tsx`: 요약 표시를 위한 레이아웃 수정

## 🚀 Ready for Development

이 스토리는 노트 내용 기반 자동 요약 생성 기능을 구현합니다. Story 4.1에서 구축한 Gemini API 인프라를 활용하여 사용자가 노트를 저장할 때 자동으로 핵심 내용을 요약하는 기능을 제공합니다. 모든 기술적 요구사항과 제약사항이 명확히 정의되어 있어 개발자가 즉시 구현을 시작할 수 있습니다.
