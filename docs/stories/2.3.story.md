# Story 2.3: 노트 상세 조회, 수정 및 자동 저장

## Status

Done

## Story

**As a** 로그인한 사용자,
**I want** 특정 노트를 상세히 조회하고 수정할 수 있으며, 변경사항이 자동으로 저장되는 기능,
**so that** 노트를 안전하고 편리하게 편집할 수 있다.

## Acceptance Criteria

1. 노트 ID로 특정 노트의 상세 내용을 조회할 수 있어야 한다
2. 제목과 본문을 실시간으로 편집할 수 있어야 한다
3. 변경사항이 3초 후 자동으로 저장되어야 한다
4. 저장 상태가 시각적으로 표시되어야 한다 (저장 중, 저장 완료, 저장 실패)
5. 노트가 존재하지 않을 때 404 에러 페이지가 표시되어야 한다
6. 다른 사용자의 노트에 접근할 수 없어야 한다 (권한 검증)
7. 편집 중 브라우저를 닫거나 새로고침 시 변경사항이 유지되어야 한다
8. 뒤로가기 버튼으로 노트 목록으로 돌아갈 수 있어야 한다
9. 반응형 디자인으로 모바일에서도 편집이 편리해야 한다
10. 키보드 단축키를 지원해야 한다 (Cmd/Ctrl+S로 즉시 저장)

## Tasks / Subtasks

-   [x] 노트 상세 페이지 개선 (AC: 1, 5, 6, 8, 9)
    -   [x] 노트 조회 로직 강화 (권한 검증 포함)
    -   [x] 404 에러 페이지 구현 (기존 notFound() 활용)
    -   [x] 뒤로가기 네비게이션 추가
    -   [x] 반응형 레이아웃 최적화
-   [x] 실시간 편집 기능 구현 (AC: 2, 10)
    -   [x] 제목 입력 필드를 인라인 편집으로 변경
    -   [x] 본문 textarea 최적화 (자동 높이 조절)
    -   [x] 키보드 단축키 핸들러 추가
    -   [x] 편집 상태 관리 (React state)
-   [x] 자동 저장 시스템 구현 (AC: 3, 4, 7)
    -   [x] debounce 기반 자동 저장 로직
    -   [x] 저장 상태 표시 UI 컴포넌트
    -   [x] 에러 핸들링 및 재시도 메커니즘
    -   [x] 로컬 스토리지 백업 (오프라인 지원)
-   [x] 노트 업데이트 Server Action 구현
    -   [x] 부분 업데이트 지원 (제목 또는 본문만)
    -   [x] 낙관적 업데이트 적용 (클라이언트 상태로 구현)
    -   [x] 동시 편집 충돌 방지 (기본 수준)

## Dev Notes

### 이전 스토리 인사이트

[Source: Story 2.2 Dev Agent Records]

-   ✅ 기본 노트 상세 페이지 구조 이미 생성됨 (`app/notes/[id]/page.tsx`)
-   ✅ `getNoteById()` 함수 권한 검증 포함 구현됨 (`lib/notes/queries.ts`)
-   ✅ 노트 카드 → 상세 페이지 네비게이션 동작 확인됨

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **UI:** shadcn/ui + Tailwind + Radix UI
-   **DB/ORM:** Drizzle ORM + Supabase (PostgreSQL)
-   **상태 관리:** React useState/useEffect (클라이언트 상태)

### 자동 저장 설계

**Debounce 전략:**

```typescript
// 사용자 입력 후 3초 대기 후 저장
const AUTOSAVE_DELAY = 3000

useEffect(() => {
    const timer = setTimeout(() => {
        if (hasChanges) {
            saveNote(noteData)
        }
    }, AUTOSAVE_DELAY)

    return () => clearTimeout(timer)
}, [title, content])
```

**저장 상태 관리:**

```typescript
type SaveStatus = 'idle' | 'saving' | 'saved' | 'error'

const [saveStatus, setSaveStatus] = useState<SaveStatus>('idle')
```

**로컬 스토리지 백업:**

```typescript
// 편집 중 데이터를 로컬에 임시 저장
useEffect(() => {
    localStorage.setItem(
        `note-draft-${noteId}`,
        JSON.stringify({
            title,
            content,
            lastModified: Date.now()
        })
    )
}, [title, content, noteId])
```

### UI/UX 고려사항

**편집 인터페이스:**

-   **제목**: 클릭 시 인라인 편집 모드로 전환
-   **본문**: 자동 높이 조절 textarea
-   **저장 표시**: 우상단에 상태 배지 표시
-   **뒤로가기**: 좌상단에 버튼 배치

**저장 상태 UI:**

-   **저장 중**: 회전하는 스피너 + "저장 중..."
-   **저장 완료**: 체크마크 + "저장됨" (2초 후 페이드아웃)
-   **저장 실패**: 경고 아이콘 + "저장 실패" + 재시도 버튼

**키보드 단축키:**

-   **Cmd/Ctrl + S**: 즉시 저장
-   **Escape**: 편집 모드 종료 (제목 편집 시)

### 성능 최적화

**클라이언트 최적화:**

-   debounce로 불필요한 API 호출 방지
-   React.memo로 불필요한 리렌더링 방지
-   textarea 가상화 (매우 긴 텍스트 대응)

**서버 최적화:**

-   부분 업데이트로 네트워크 트래픽 감소
-   낙관적 업데이트로 UX 향상
-   에러 재시도로 안정성 확보

### 재사용 가능한 컴포넌트

-   `components/notes/note-editor.tsx` - 노트 편집 메인 컴포넌트 (새로 추가)
-   `components/notes/save-status.tsx` - 저장 상태 표시 (새로 추가)
-   `components/notes/auto-resize-textarea.tsx` - 자동 크기 조절 텍스트 영역 (새로 추가)
-   `components/ui/back-button.tsx` - 뒤로가기 버튼 (새로 추가)

### 접근성 고려사항

-   **스크린 리더**: 저장 상태 변경 시 live region으로 알림
-   **키보드 네비게이션**: Tab으로 편집 영역 간 이동
-   **포커스 관리**: 페이지 로드 시 제목 필드에 포커스
-   **색상 대비**: 저장 상태 색상이 WCAG 2.1 AA 준수

### 에러 처리

**클라이언트 에러:**

-   네트워크 오류 시 로컬 스토리지에 백업
-   자동 재시도 (최대 3회)
-   사용자에게 명확한 에러 메시지 표시

**서버 에러:**

-   404: 노트 없음 → 전용 404 페이지
-   403: 권한 없음 → 에러 메시지 + 목록으로 리다이렉트
-   500: 서버 오류 → 재시도 버튼 제공

### URL 상태 관리

**라우트 구조:**

```
/notes/[id] - 노트 상세 조회/편집
/notes/[id]/edit - (선택사항) 명시적 편집 모드
```

**브라우저 히스토리:**

-   뒤로가기 시 변경사항 확인 대화상자 (미저장 시)
-   새로고침 시 로컬 스토리지에서 복원

### Testing

#### 단위 테스트

-   자동 저장 debounce 로직 테스트
-   저장 상태 변경 테스트
-   로컬 스토리지 백업/복원 테스트

#### 통합 테스트

-   노트 편집 → 자동 저장 플로우
-   권한 검증 테스트
-   에러 처리 시나리오

#### E2E 테스트

-   노트 목록 → 상세 → 편집 → 저장 플로우
-   네트워크 오류 시 로컬 백업 동작
-   키보드 단축키 테스트

### 프로젝트 구조

**새로 추가될 파일:**

-   `components/notes/note-editor.tsx` - 메인 편집 컴포넌트
-   `components/notes/save-status.tsx` - 저장 상태 표시
-   `components/notes/auto-resize-textarea.tsx` - 자동 크기 조절
-   `components/ui/back-button.tsx` - 뒤로가기 버튼
-   `app/not-found.tsx` - 404 에러 페이지 (전역)
-   `app/notes/[id]/not-found.tsx` - 노트별 404 페이지
-   `lib/notes/hooks.ts` - 노트 편집 관련 커스텀 훅
-   `lib/utils/debounce.ts` - debounce 유틸리티

**수정될 파일:**

-   `app/notes/[id]/page.tsx` - 편집 기능 통합
-   `lib/notes/actions.ts` - 노트 업데이트 Server Action 추가
-   `lib/notes/queries.ts` - 필요시 쿼리 최적화

## Change Log

| Date       | Version | Description      | Author                    |
| ---------- | ------- | ---------------- | ------------------------- |
| 2025-09-14 | 1.0     | 스토리 생성      | Dev Agent Claude 4 Sonnet |
| 2025-09-14 | 2.0     | 스토리 구현 완료 | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude 4 Sonnet

### Debug Log References

-   성공적으로 모든 Acceptance Criteria 구현 완료
-   타입 안전성 확보 (any 타입 제거, 명시적 타입 정의)
-   ESLint 규칙 준수 (spread operator 사용)
-   모든 컴포넌트 접근성 고려사항 적용

### Completion Notes List

1. ✅ **자동 저장 시스템**: 3초 debounce 기반으로 안정적 구현
2. ✅ **인라인 편집**: 제목 클릭으로 편집 모드 전환, Enter/Escape 키 지원
3. ✅ **자동 크기 조절**: textarea가 내용에 따라 자동으로 높이 조절
4. ✅ **저장 상태 표시**: 저장 중/완료/실패 상태를 시각적으로 표시
5. ✅ **키보드 단축키**: Cmd/Ctrl+S로 즉시 저장 기능
6. ✅ **로컬 스토리지 백업**: 브라우저 종료 시에도 변경사항 보존
7. ✅ **권한 검증**: 타인의 노트 접근 차단
8. ✅ **반응형 디자인**: 모바일 환경에서도 편리한 편집
9. ✅ **에러 처리**: 네트워크 오류 시 재시도 메커니즘
10. ✅ **접근성**: 스크린 리더 지원, 키보드 네비게이션

### File List

**새로 생성된 파일:**

-   `lib/utils/debounce.ts` - 타입 안전한 debounce 유틸리티
-   `lib/notes/hooks.ts` - 자동 저장 커스텀 훅
-   `components/ui/back-button.tsx` - 뒤로가기 버튼 컴포넌트
-   `components/notes/save-status.tsx` - 저장 상태 표시 컴포넌트
-   `components/notes/auto-resize-textarea.tsx` - 자동 크기 조절 텍스트 영역
-   `components/notes/note-editor.tsx` - 메인 노트 편집기 컴포넌트

**수정된 파일:**

-   `lib/notes/actions.ts` - updateNote Server Action 추가
-   `app/notes/[id]/page.tsx` - NoteEditor 컴포넌트로 교체

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
