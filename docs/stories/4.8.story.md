# Story 4.8: 토큰 사용량 모니터링

## 📋 기본 정보

- **Epic:** 4 - AI 기반 요약 및 태깅
- **Story ID:** 4.8
- **Title:** 토큰 사용량 모니터링
- **Status:** Draft
- **Story Points:** 2
- **Priority:** P2 (Medium)

## 📖 Story

**As a** 개발자  
**I want to** AI API 토큰 사용량을 모니터링하여  
**So that** 비용을 관리하고 성능을 최적화할 수 있다

## ✅ Acceptance Criteria

1. **토큰 사용량 추적**: 각 AI 요청별 토큰 사용량 기록
2. **사용량 통계**: 일일/월별 토큰 사용량 통계 제공
3. **사용량 제한**: 토큰 사용량 제한 설정 및 알림
4. **비용 계산**: 토큰 사용량 기반 비용 계산
5. **사용량 대시보드**: 토큰 사용량을 시각적으로 표시
6. **사용량 최적화**: 토큰 사용량 최적화 제안

## 🔧 Dev Notes

### Tech Stack
- **프레임워크**: Next.js 15.5.3 (App Router, Server Actions)
- **UI 라이브러리**: shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스**: Supabase Postgres
- **ORM**: Drizzle ORM 0.44.5
- **AI 모델**: Google Gemini API (@google/genai 1.24.0)
- **모델명**: gemini-2.0-flash-001
- **호스팅**: Vercel
- **개발 도구**: TypeScript, ESLint, Drizzle Kit

### Previous Story Insights
- 스토리 4.1에서 Gemini API 연동 완료 (`lib/ai/gemini.ts`)
- 스토리 4.2에서 자동 요약 생성 기능 완료
- 스토리 4.3에서 자동 태그 생성 기능 완료
- 스토리 4.4에서 AI 처리 상태 표시 기능 완료
- 스토리 4.5에서 AI 결과 재생성 기능 완료
- 스토리 4.6에서 요약/태그 수동 편집 기능 완료
- 스토리 4.7에서 AI 처리 에러 핸들링 기능 완료
- `regenerateAI` 서버 액션 이미 구현됨 (`lib/notes/actions.ts`)

### Data Models
- **토큰 사용량**: 
  - id: UUID (기본키)
  - noteId: UUID (notes 테이블 외래키)
  - userId: UUID (사용자 ID)
  - requestType: text ('summary', 'tags', 'both')
  - inputTokens: integer (입력 토큰 수)
  - outputTokens: integer (출력 토큰 수)
  - totalTokens: integer (총 토큰 수)
  - cost: decimal (비용)
  - createdAt: timestamp with timezone
  [Source: lib/db/schema/notes.ts]

- **사용량 제한**: 
  - id: UUID (기본키)
  - userId: UUID (사용자 ID)
  - dailyLimit: integer (일일 제한)
  - monthlyLimit: integer (월별 제한)
  - currentDailyUsage: integer (현재 일일 사용량)
  - currentMonthlyUsage: integer (현재 월별 사용량)
  - lastResetDate: date (마지막 리셋 날짜)
  [Source: lib/db/schema/notes.ts]

### API Specifications
- **토큰 계산**: 입력/출력 텍스트를 토큰으로 변환
- **사용량 추적**: 각 AI 요청별 토큰 사용량 기록
- **제한 확인**: 사용량 제한 초과 여부 확인
- **통계 생성**: 사용량 통계 및 트렌드 분석

### Component Specifications
- 토큰 사용량을 시각적으로 표시하는 대시보드 필요
- 사용량 제한 설정 UI 필요
- 사용량 통계 차트 필요
- 최적화 제안 UI 필요

### File Locations
- **토큰 계산**: `lib/ai/token-calculator.ts` (신규 생성)
- **사용량 추적**: `lib/ai/usage-tracker.ts` (신규 생성)
- **사용량 대시보드**: `components/notes/usage-dashboard.tsx` (신규 생성)
- **사용량 차트**: `components/notes/usage-chart.tsx` (신규 생성)
- **제한 설정**: `components/notes/usage-limits.tsx` (신규 생성)

### Testing Requirements
- 토큰 계산 정확성 테스트
- 사용량 추적 테스트
- 제한 확인 테스트
- 통계 생성 테스트
- 대시보드 UI 테스트

### Technical Constraints
- **성능**: 토큰 계산이 AI 처리 성능에 영향을 주지 않도록 최적화
- **정확성**: 토큰 계산의 정확성 보장
- **확장성**: 대량의 사용량 데이터 처리
- **보안**: 사용량 데이터의 보안 및 프라이버시 보호

### Implementation Notes
- 토큰 계산은 AI 요청 전후에 수행
- 사용량 데이터는 실시간으로 업데이트
- 제한 초과 시 사용자에게 알림
- 통계는 주기적으로 계산하여 캐시

## 📝 Tasks / Subtasks

### Task 1: 토큰 계산 로직 구현 (AC: 1)
- [ ] `lib/ai/token-calculator.ts` 파일 생성
- [ ] 입력 텍스트 토큰 계산 함수 구현
- [ ] 출력 텍스트 토큰 계산 함수 구현
- [ ] 토큰 계산 정확성 검증 로직 구현

### Task 2: 사용량 추적 시스템 구현 (AC: 1, 2)
- [ ] `lib/ai/usage-tracker.ts` 파일 생성
- [ ] 토큰 사용량 기록 로직 구현
- [ ] 사용량 통계 계산 로직 구현
- [ ] 사용량 데이터 조회 로직 구현

### Task 3: 사용량 제한 시스템 구현 (AC: 3)
- [ ] 사용량 제한 설정 로직 구현
- [ ] 제한 초과 확인 로직 구현
- [ ] 제한 초과 알림 로직 구현
- [ ] 제한 리셋 로직 구현

### Task 4: 비용 계산 시스템 구현 (AC: 4)
- [ ] 토큰당 비용 계산 로직 구현
- [ ] 총 비용 계산 로직 구현
- [ ] 비용 통계 생성 로직 구현
- [ ] 비용 예측 로직 구현

### Task 5: 사용량 대시보드 UI 구현 (AC: 5)
- [ ] `components/notes/usage-dashboard.tsx` 컴포넌트 생성
- [ ] 사용량 통계 표시 구현
- [ ] 사용량 차트 구현
- [ ] 사용량 제한 표시 구현

### Task 6: 사용량 최적화 제안 구현 (AC: 6)
- [ ] 토큰 사용량 분석 로직 구현
- [ ] 최적화 제안 생성 로직 구현
- [ ] 최적화 제안 UI 구현
- [ ] 최적화 효과 측정 로직 구현

### Task 7: 서버 액션에 사용량 추적 통합 (AC: 1)
- [ ] `lib/notes/actions.ts`에 사용량 추적 로직 통합
- [ ] AI 요청 전후 토큰 계산
- [ ] 사용량 데이터 저장
- [ ] 제한 확인 및 알림

### Task 8: 단위 테스트 작성
- [ ] 토큰 계산 로직 테스트
- [ ] 사용량 추적 테스트
- [ ] 제한 확인 테스트
- [ ] 비용 계산 테스트
- [ ] 대시보드 UI 테스트

## 🧪 Testing Strategy

- **단위 테스트**: 토큰 계산, 사용량 추적, 제한 확인
- **통합 테스트**: AI 요청 전체 플로우에서 사용량 추적
- **UI 테스트**: 대시보드 컴포넌트 렌더링
- **성능 테스트**: 대량 데이터 처리 성능
- **정확성 테스트**: 토큰 계산 및 비용 계산 정확성

## 📁 File List

- `lib/ai/token-calculator.ts` (신규) - 토큰 계산 로직
- `lib/ai/usage-tracker.ts` (신규) - 사용량 추적 시스템
- `components/notes/usage-dashboard.tsx` (신규) - 사용량 대시보드
- `components/notes/usage-chart.tsx` (신규) - 사용량 차트
- `components/notes/usage-limits.tsx` (신규) - 사용량 제한 설정
- `lib/notes/actions.ts` (수정) - 사용량 추적 통합

## 🔗 Dependencies

- Story 4.1: Gemini API 설정 및 연동 (필수 완료)
- Story 4.2: 노트 내용 기반 자동 요약 생성 (필수 완료)
- Story 4.3: 노트 내용 기반 자동 태그 생성 (필수 완료)
- Story 4.4: AI 처리 상태 표시 (필수 완료)
- Story 4.5: AI 결과 재생성 기능 (필수 완료)
- Story 4.6: 요약/태그 수동 편집 기능 (필수 완료)
- Story 4.7: AI 처리 에러 핸들링 (필수 완료)
- Epic 2: 노트 관리 시스템 (노트 CRUD 기능)

## 📊 Definition of Done

- [ ] 모든 Tasks와 Subtasks 완료
- [ ] 단위 테스트 통과
- [ ] 토큰 사용량 추적 동작 확인
- [ ] 사용량 통계 생성 확인
- [ ] 사용량 제한 설정 및 확인 동작
- [ ] 비용 계산 동작 확인
- [ ] 사용량 대시보드 표시 확인
- [ ] 최적화 제안 기능 동작 확인
- [ ] 코드 리뷰 완료
- [ ] 문서 업데이트 완료

## 📝 Dev Agent Record

### Agent Model Used
- Claude Sonnet 4

### Debug Log References
- (구현 후 업데이트 예정)

### Completion Notes
- (구현 후 업데이트 예정)

### Change Log
- (구현 후 업데이트 예정)

## 🚀 Ready for Development

이 스토리는 토큰 사용량 모니터링 기능을 구현합니다. Story 4.1-4.7에서 구축한 AI 기능들을 사용할 때 발생하는 토큰 사용량을 추적하고 관리하여 비용을 최적화하고 성능을 모니터링하는 기능을 제공합니다. 모든 기술적 요구사항과 제약사항이 명확히 정의되어 있어 개발자가 즉시 구현을 시작할 수 있습니다.
