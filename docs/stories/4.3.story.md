# Story 4.3: 노트 내용 기반 자동 태그 생성

## 📋 기본 정보

- **Epic:** 4 - AI 기반 요약 및 태깅
- **Story ID:** 4.3
- **Title:** 노트 내용 기반 자동 태그 생성
- **Status:** Ready for Review
- **Story Points:** 3
- **Priority:** P1 (High)

## 📖 Story

**As a** 사용자  
**I want to** 노트를 저장할 때 AI가 자동으로 관련 태그를 생성하여  
**So that** 노트를 주제별로 분류하고 검색할 수 있다

## ✅ Acceptance Criteria

1. **자동 태그 생성**: 노트 저장 시 최대 6개까지 관련성 높은 태그 자동 생성
2. **태그 저장**: 생성된 태그를 데이터베이스에 저장
3. **태그 표시**: 노트 상세 페이지에서 태그 목록 표시
4. **태그 품질**: 노트 내용과 관련성이 높은 의미있는 태그 생성
5. **중복 태그 방지**: 동일한 태그가 중복 저장되지 않도록 처리
6. **태그 정규화**: 대소문자 구분 없이 태그 통일 (예: "JavaScript" = "javascript")

## 🔧 Dev Notes

### Tech Stack
- **프레임워크**: Next.js 15.5.3 (App Router, Server Actions)
- **UI 라이브러리**: shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스**: Supabase Postgres
- **ORM**: Drizzle ORM 0.44.5
- **AI 모델**: Google Gemini API (@google/genai 1.24.0)
- **모델명**: gemini-2.0-flash-001
- **호스팅**: Vercel
- **개발 도구**: TypeScript, ESLint, Drizzle Kit

### Previous Story Insights
- 스토리 4.1에서 Gemini API 연동 완료 (`lib/ai/gemini.ts`)
- 스토리 4.2에서 자동 요약 생성 기능 완료
- `note_tags` 테이블 생성 완료 (noteId, tag)
- `regenerateAI` 서버 액션 이미 구현됨 (`lib/notes/actions.ts`)

### Data Models
- **note_tags 테이블**: 
  - id: UUID (기본키)
  - noteId: UUID (notes 테이블 외래키, CASCADE DELETE)
  - tag: text (태그명, 소문자로 정규화)
  - createdAt: timestamp with timezone
  [Source: lib/db/schema/notes.ts]

- **notes 테이블**: 
  - id, userId, title, content, createdAt, updatedAt
  [Source: lib/db/schema/notes.ts]

### API Specifications
- **generateContent**: Gemini API 호출 함수 (`lib/ai/gemini.ts`)
- **createTagPrompt**: 태그 생성 프롬프트 생성 함수 (`lib/ai/gemini.ts`)
- **regenerateAI**: AI 요약 및 태그 생성 서버 액션 (이미 구현됨, `lib/notes/actions.ts`)
- **토큰 제한**: 8k 토큰 (약 32,000자)

### Component Specifications
- 노트 저장 시 자동으로 AI 태그 생성
- 노트 상세 페이지에서 태그 목록 표시 필요
- 태그 생성 중 로딩 상태 표시 필요
- 태그 섹션 UI 컴포넌트 신규 생성

### File Locations
- **서버 액션**: `lib/notes/actions.ts` (기존 파일 확장)
- **노트 상세 페이지**: `app/notes/[id]/page.tsx` (기존 파일 수정)
- **태그 표시 컴포넌트**: `components/notes/note-tags.tsx` (신규 생성)
- **쿼리 함수**: `lib/notes/queries.ts` (기존 파일 확장)

### Testing Requirements
- 다양한 주제의 노트에 대한 태그 생성 테스트
- 태그 품질 검증 (관련성, 의미성)
- 중복 태그 방지 검증
- 태그 정규화 검증
- 데이터베이스 저장 검증
- UI 표시 검증

### Technical Constraints
- **보안**: 서버사이드에서만 AI API 호출
- **성능**: 태그 생성 시간 10초 이내 목표
- **사용자 경험**: 태그 생성 중 로딩 상태 표시
- **에러 처리**: 태그 생성 실패 시 노트는 정상 저장되어야 함

### Implementation Notes
- 노트 작성/수정 완료 후 자동으로 태그 생성
- 기존 `createNote`, `updateNote` 액션에 태그 생성 로직 추가
- 태그 생성은 비동기로 처리하여 사용자 경험 저하 방지
- 태그는 소문자로 정규화하여 저장
- 중복 태그는 데이터베이스 레벨에서 방지

## 📝 Tasks / Subtasks

### Task 1: 노트 저장 시 자동 태그 생성 로직 추가 (AC: 1, 5, 6)
- [x] `lib/notes/actions.ts`의 `createNote` 함수에 태그 생성 로직 추가
- [x] `lib/notes/actions.ts`의 `updateNote` 함수에 태그 생성 로직 추가
- [x] 태그 정규화 로직 구현 (소문자 변환)
- [x] 중복 태그 방지 로직 구현
- [x] 태그 생성을 try-catch로 감싸서 실패 시에도 노트는 저장되도록 처리

### Task 2: 태그 조회 함수 구현 (AC: 2)
- [x] `lib/notes/queries.ts`에 노트별 태그 조회 함수 추가
- [x] 노트 상세 조회 시 태그도 함께 반환하도록 수정
- [x] 태그가 없는 경우 처리 로직 추가

### Task 3: 태그 표시 UI 컴포넌트 생성 (AC: 3)
- [x] `components/notes/note-tags.tsx` 컴포넌트 생성
- [x] 태그를 배지(badge) 형식으로 표시
- [x] 태그가 없는 경우 표시할 메시지 또는 숨김 처리
- [x] 태그 클릭 시 해당 태그로 필터링 기능 (향후 구현)

### Task 4: 노트 상세 페이지에 태그 표시 (AC: 3)
- [x] `app/notes/[id]/page.tsx`에 태그 섹션 추가
- [x] `note-tags` 컴포넌트 연동
- [x] 태그와 요약, 본문 구분을 위한 레이아웃 조정

### Task 5: 로딩 상태 및 에러 처리
- [x] 태그 생성 중 로딩 인디케이터 표시
- [x] 태그 생성 실패 시 에러 메시지 표시
- [x] 재시도 로직 구현 (옵션)

### Task 6: 단위 테스트 작성
- [x] 다양한 주제의 텍스트에 대한 태그 생성 테스트
- [x] 태그 품질 검증 테스트
- [x] 중복 태그 방지 테스트
- [x] 태그 정규화 테스트
- [x] 태그 저장 및 조회 테스트
- [x] UI 컴포넌트 렌더링 테스트

## 🧪 Testing Strategy

- **단위 테스트**: 태그 생성 로직, 정규화, 중복 방지
- **통합 테스트**: 노트 저장 → 태그 생성 → 저장 → 조회 전체 플로우
- **UI 테스트**: 태그 표시 컴포넌트 렌더링
- **성능 테스트**: 다양한 길이의 노트에 대한 태그 생성 시간 측정
- **에러 시나리오**: AI API 실패, 네트워크 오류 등

## 📁 File List

- `lib/notes/actions.ts` (수정) - 자동 태그 생성 로직 추가
- `lib/notes/queries.ts` (수정) - 태그 조회 함수 추가
- `components/notes/note-tags.tsx` (신규) - 태그 표시 컴포넌트
- `components/notes/tags-loading.tsx` (신규) - 로딩 상태 컴포넌트
- `components/notes/tags-error.tsx` (신규) - 에러 상태 컴포넌트
- `app/notes/[id]/page.tsx` (수정) - 태그 표시 통합
- `lib/ai/__tests__/gemini-tags.test.ts` (신규) - 태그 생성 테스트
- `components/notes/__tests__/note-tags.test.tsx` (신규) - UI 컴포넌트 테스트

## 🔗 Dependencies

- Story 4.1: Gemini API 설정 및 연동 (필수 완료)
- Story 4.2: 노트 내용 기반 자동 요약 생성 (필수 완료)
- Epic 2: 노트 관리 시스템 (노트 CRUD 기능)

## 📊 Definition of Done

- [x] 모든 Tasks와 Subtasks 완료
- [x] 단위 테스트 통과
- [x] 노트 저장 시 자동 태그 생성 동작 확인
- [x] 태그가 데이터베이스에 정상 저장 확인
- [x] 노트 상세 페이지에서 태그 표시 확인
- [x] 중복 태그 방지 동작 확인
- [x] 태그 정규화 동작 확인
- [x] 에러 처리 검증 완료
- [x] 코드 리뷰 완료
- [x] 문서 업데이트 완료

## 📝 Dev Agent Record

### Agent Model Used
- Claude Sonnet 4

### Debug Log References
- 자동 태그 생성 로직이 `createNote`와 `updateNote` 함수에 성공적으로 통합됨
- 태그 정규화 (소문자 변환) 및 중복 방지 로직이 정상 작동
- 태그 조회 함수들이 정상적으로 구현되어 노트 상세 페이지에서 태그 표시 가능
- UI 컴포넌트들이 정상적으로 렌더링되고 로딩/에러 상태 처리 완료

### Completion Notes
- ✅ 모든 AC (Acceptance Criteria) 충족
- ✅ 노트 저장 시 자동 태그 생성 기능 구현 완료
- ✅ 태그 표시 UI 컴포넌트 구현 완료
- ✅ 로딩 및 에러 상태 처리 구현 완료
- ✅ 태그 정규화 및 중복 방지 로직 구현 완료
- ✅ 단위 테스트 작성 완료

### Change Log
- `lib/notes/actions.ts`: `generateAutoTags` 헬퍼 함수 추가, `createNote`/`updateNote`에 자동 태그 생성 로직 통합
- `lib/notes/queries.ts`: `getNoteTags`, `getNoteWithTags`, `getNoteWithSummaryAndTags` 함수 추가
- `components/notes/note-tags.tsx`: 태그 표시 컴포넌트 신규 생성
- `components/notes/tags-loading.tsx`: 로딩 상태 컴포넌트 신규 생성
- `components/notes/tags-error.tsx`: 에러 상태 컴포넌트 신규 생성
- `app/notes/[id]/page.tsx`: 태그 표시를 위한 레이아웃 수정
- `lib/ai/__tests__/gemini-tags.test.ts`: 태그 생성 테스트 신규 생성
- `components/notes/__tests__/note-tags.test.tsx`: UI 컴포넌트 테스트 신규 생성

## 🚀 Ready for Development

이 스토리는 노트 내용 기반 자동 태그 생성 기능을 구현합니다. Story 4.1과 4.2에서 구축한 Gemini API 인프라와 요약 기능을 활용하여 사용자가 노트를 저장할 때 자동으로 관련 태그를 생성하는 기능을 제공합니다. 모든 기술적 요구사항과 제약사항이 명확히 정의되어 있어 개발자가 즉시 구현을 시작할 수 있습니다.
