# Story 4.1: Gemini API 설정 및 연동

## 📋 기본 정보

- **Epic:** 4 - AI 기반 요약 및 태깅
- **Story ID:** 4.1
- **Title:** Gemini API 설정 및 연동
- **Status:** Ready for Review
- **Story Points:** 2
- **Priority:** P1 (High)

## 📖 Story

**As a** 개발자  
**I want to** Google Gemini API를 프로젝트에 설정하고 연동하여  
**So that** AI 기반 요약 및 태깅 기능의 기반을 구축할 수 있다

## ✅ Acceptance Criteria

1. **API 키 설정**: Google Gemini API 키를 환경변수로 안전하게 설정
2. **API 클라이언트 구성**: Gemini API 호출을 위한 클라이언트 라이브러리 설치 및 설정
3. **서버 액션 구현**: Gemini API 호출을 위한 서버 액션 함수 생성
4. **에러 핸들링**: API 호출 실패 시 적절한 에러 처리 구현
5. **토큰 제한 관리**: 8k 토큰 제한을 고려한 입력 검증 로직 구현

## 🔧 Dev Notes

### Tech Stack
- **프레임워크**: Next.js 15.5.3 (App Router, Server Actions)
- **UI 라이브러리**: shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스**: Supabase Postgres
- **ORM**: Drizzle ORM 0.44.5
- **AI 모델**: Google Gemini API (새로 추가될 패키지: @google/genai)
- **호스팅**: Vercel
- **개발 도구**: TypeScript, ESLint, Drizzle Kit

### Previous Story Insights
- Epic 2에서 노트 관리 시스템이 완성되어 AI 처리할 노트 데이터가 준비됨
- Drizzle ORM과 Supabase 연동이 완료되어 데이터베이스 스키마 확정됨

### Data Models
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#2]
- **summaries 테이블**: note_id, model, content, created_at [Source: architecture.md#2]
- **note_tags 테이블**: note_id, tag [Source: architecture.md#2]

### API Specifications
- **Google Gemini API**: 요약/태깅을 위한 AI 모델 [Source: architecture.md#1]
- **토큰 제한**: 8k 토큰 제한 관리 필요 [Source: architecture.md#6]
- **서버 액션**: `regenerateAI` - Gemini 호출 후 요약/태그 저장 [Source: architecture.md#4]

### Component Specifications
- 서버사이드에서만 API 호출 (클라이언트 직접 호출 금지) [Source: architecture.md#3]
- 비동기 처리 및 로딩 상태 관리 필요 [Source: epic-4-ai-summarization-tagging.md#26]

### File Locations
- **서버 액션**: `lib/notes/actions.ts` (기존 파일 확장)
- **API 유틸리티**: `lib/ai/gemini.ts` (신규 생성)
- **환경변수**: `.env.local` (기존 파일 확장)

### Testing Requirements
- API 키 설정 검증 테스트
- 토큰 제한 검증 테스트
- 에러 핸들링 테스트
- API 응답 형식 검증 테스트

### Technical Constraints
- **보안**: Supabase 서비스 롤 키는 서버 전용 [Source: architecture.md#3]
- **성능**: 요약 길이 제한(8k 토큰), Gemini 무료 할당 활용 [Source: architecture.md#6]
- **프레임워크**: Next.js Server Actions 사용 [Source: architecture.md#1]

### @google/genai 패키지 사용법
```typescript
import { GoogleGenAI } from "@google/genai";

// API 클라이언트 초기화
const genAI = new GoogleGenAI({ apiKey: process.env.GOOGLE_API_KEY });

// 텍스트 생성 예시
async function generateContent(prompt: string) {
  const result = await genAI.models.generateContent({
    model: "gemini-2.0-flash-001",
    contents: prompt
  });
  return result.text;
}
```

**설치 명령어**: `npm install @google/genai`  
**환경변수**: `GOOGLE_API_KEY=your_api_key_here`  
**모델**: `gemini-2.0-flash-001` (최신 모델)

## 📝 Tasks / Subtasks

### Task 1: 환경 설정 및 의존성 설치 (AC: 1)
- [x] Google Gemini API 키를 `.env.local`에 추가
- [x] `@google/genai` 패키지 설치
- [x] 환경변수 타입 정의 추가

### Task 2: Gemini API 클라이언트 구현 (AC: 2)
- [x] `lib/ai/gemini.ts` 파일 생성
- [x] Gemini API 클라이언트 초기화 함수 구현
- [x] API 키 검증 로직 추가

### Task 3: 서버 액션 구현 (AC: 3)
- [x] `lib/notes/actions.ts`에 `regenerateAI` 함수 추가
- [x] 노트 내용을 Gemini API로 전송하는 로직 구현
- [x] 응답 데이터 파싱 및 검증 로직 구현

### Task 4: 에러 핸들링 구현 (AC: 4)
- [x] API 호출 실패 시 에러 처리
- [x] 네트워크 타임아웃 처리
- [x] API 응답 형식 검증
- [x] 사용자 친화적 에러 메시지 반환

### Task 5: 토큰 제한 관리 (AC: 5)
- [x] 입력 텍스트 길이 검증 함수 구현
- [x] 8k 토큰 제한 체크 로직 추가
- [x] 토큰 초과 시 적절한 에러 처리

### Task 6: 단위 테스트 작성
- [x] API 클라이언트 초기화 테스트
- [x] 토큰 제한 검증 테스트
- [x] 에러 핸들링 테스트
- [x] API 응답 파싱 테스트

## 🧪 Testing Strategy

- **단위 테스트**: 각 함수별 독립적 테스트
- **통합 테스트**: API 호출 전체 플로우 테스트
- **에러 시나리오**: 네트워크 실패, API 키 오류, 토큰 초과 등
- **성능 테스트**: 토큰 제한 내에서의 처리 시간 측정

## 📁 File List

- `lib/ai/gemini.ts` (신규)
- `lib/ai/__tests__/gemini.test.ts` (신규)
- `lib/notes/actions.ts` (수정)
- `lib/db/schema/notes.ts` (수정)
- `types/env.d.ts` (신규)
- `.env.local` (수정)
- `package.json` (수정)
- `drizzle/0002_nasty_silhouette.sql` (신규)

## 🔗 Dependencies

- Epic 2: 노트 관리 시스템 (노트 데이터 필요)
- Google Gemini API 계정 및 키

## 📊 Definition of Done

- [ ] 모든 Tasks와 Subtasks 완료
- [ ] 단위 테스트 통과
- [ ] API 키 설정 검증 완료
- [ ] 에러 핸들링 검증 완료
- [ ] 토큰 제한 관리 검증 완료
- [ ] 코드 리뷰 완료
- [ ] 문서 업데이트 완료

## 📝 Dev Agent Record

### Agent Model Used
- Claude Sonnet 4

### Debug Log References
- 패키지 설치: `@google/genai 1.24.0` 성공적으로 설치됨
- 마이그레이션 생성: `drizzle/0002_nasty_silhouette.sql` 생성됨
- 린팅 검사: 모든 파일에서 린터 오류 없음

### Completion Notes
- ✅ 모든 AC (Acceptance Criteria) 달성
- ✅ Gemini API 클라이언트 완전 구현
- ✅ 서버 액션 `regenerateAI` 함수 구현
- ✅ 에러 핸들링 및 토큰 제한 관리 완료
- ✅ 단위 테스트 작성 완료
- ✅ 데이터베이스 스키마 확장 (summaries, note_tags 테이블)

### Change Log
- 2024-01-14: `@google/genai` 패키지 설치 및 환경변수 설정
- 2024-01-14: `lib/ai/gemini.ts` 클라이언트 구현
- 2024-01-14: `lib/notes/actions.ts`에 `regenerateAI` 함수 추가
- 2024-01-14: 데이터베이스 스키마 확장 (summaries, note_tags)
- 2024-01-14: 단위 테스트 작성 및 린팅 검사 완료

## 🚀 Ready for Development

이 스토리는 Gemini API 설정 및 연동을 위한 기반 작업으로, Epic 4의 모든 AI 기능의 토대가 됩니다. 모든 기술적 요구사항과 제약사항이 명확히 정의되어 있어 개발자가 즉시 구현을 시작할 수 있습니다.
