# Story 2.1: 노트 생성 (제목 + 본문)

## Status

Done

## Story

**As a** 로그인한 사용자,
**I want** 제목과 본문이 있는 새로운 노트를 생성할 수 있는 기능,
**so that** 내 생각과 정보를 체계적으로 기록하고 저장할 수 있다.

## Acceptance Criteria

1. 대시보드에서 "새 노트 작성" 버튼을 통해 노트 작성 페이지에 접근할 수 있어야 한다
2. 노트 제목을 입력할 수 있는 텍스트 필드가 제공되어야 한다
3. 노트 본문을 입력할 수 있는 텍스트 에리어가 제공되어야 한다
4. 노트 저장 버튼을 클릭하면 데이터베이스에 저장되어야 한다
5. 저장 성공 시 노트 목록 페이지로 리다이렉트되어야 한다
6. 제목이 비어있을 경우 "제목 없음" 기본값이 설정되어야 한다
7. 본문이 비어있어도 노트 생성이 가능해야 한다
8. 저장 중 로딩 상태가 표시되어야 한다
9. 저장 실패 시 적절한 에러 메시지가 표시되어야 한다

## Tasks / Subtasks

-   [x] Drizzle ORM 설치 및 설정 (기반 작업)
    -   [x] Drizzle ORM 및 관련 패키지 설치
    -   [x] Drizzle 설정 파일 구성 (`drizzle.config.ts`)
    -   [x] 환경 변수 설정 (`DATABASE_URL`)
    -   [x] 개발 환경 스크립트 설정
-   [x] 노트 데이터 모델 설계 및 구현 (AC: 4)
    -   [x] Drizzle 스키마 파일 생성 (`lib/db/schema/notes.ts`)
    -   [x] 노트 테이블 스키마 정의 (PostgreSQL)
    -   [x] 관계형 데이터 및 인덱스 정의
    -   [x] TypeScript 타입 자동 생성 설정
-   [x] 데이터베이스 마이그레이션 (AC: 4)
    -   [x] Drizzle 마이그레이션 파일 생성
    -   [x] Supabase에 마이그레이션 적용
    -   [x] RLS 정책 설정 (사용자별 접근 제어)
    -   [x] 마이그레이션 검증 및 테스트
-   [x] 노트 작성 페이지 구현 (AC: 1, 2, 3, 8)
    -   [x] `/notes/new` 라우트 생성
    -   [x] 노트 작성 폼 컴포넌트 구현
    -   [x] 제목 입력 필드 (Input 컴포넌트)
    -   [x] 본문 입력 에리어 (Textarea 컴포넌트)
    -   [x] 저장/취소 버튼 UI
-   [x] 노트 저장 로직 구현 (AC: 4, 5, 6, 7, 9)
    -   [x] 노트 생성 Server Action 구현
    -   [x] 클라이언트 사이드 폼 제출 처리
    -   [x] 제목 기본값 처리 로직
    -   [x] 에러 핸들링 및 사용자 피드백
    -   [x] 성공 시 리다이렉트 처리
-   [x] 대시보드 연동 (AC: 1)
    -   [x] 대시보드에 "새 노트 작성" CTA 버튼 추가
    -   [x] 노트 작성 페이지로 네비게이션 연결

## Dev Notes

### 이전 스토리 인사이트

[Source: Story 1.1, 1.2, 1.3 Dev Agent Records]

-   ✅ Supabase 인프라 및 환경 변수 설정 완료
-   ✅ Next.js Server Actions 패턴 확립
-   ✅ shadcn/ui 컴포넌트 시스템 활용 경험
-   ✅ 사용자 인증 및 권한 제어 구현 완료

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **UI:** shadcn/ui + Tailwind + Radix UI
-   **DB/인증:** Supabase (Postgres, Auth, Storage)

### 보안 요구사항

[Source: docs/architecture.md#3-보안]

-   Supabase 서비스 롤 키는 서버 전용으로 사용
-   사용자 ID 스코프로 권한 제어 (RLS 정책)

### Drizzle ORM 설정

**필요한 패키지**:

```bash
pnpm add drizzle-orm postgres dotenv
pnpm add -D drizzle-kit tsx
```

**Drizzle 설정 파일** (`drizzle.config.ts`):

```typescript
import 'dotenv/config'
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
    out: './drizzle',
    schema: './lib/db/schema/*.ts',
    dialect: 'postgresql',
    dbCredentials: {
        url: process.env.DATABASE_URL!
    }
})
```

**환경 변수 추가** (`.env.local`):

```env
# Drizzle ORM용 데이터베이스 URL
DATABASE_URL="postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres"
```

**Package.json 스크립트 추가**:

```json
{
    "scripts": {
        "db:generate": "drizzle-kit generate",
        "db:migrate": "drizzle-kit migrate",
        "db:push": "drizzle-kit push",
        "db:studio": "drizzle-kit studio"
    }
}
```

### 데이터베이스 스키마

**Drizzle 스키마 정의** (`lib/db/schema/notes.ts`):

```typescript
import { pgTable, uuid, text, timestamp } from 'drizzle-orm/pg-core'
import { createInsertSchema, createSelectSchema } from 'drizzle-zod'

export const notes = pgTable('notes', {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: uuid('user_id').notNull(),
    title: text('title').notNull().default('제목 없음'),
    content: text('content'),
    createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow()
})

// Zod 스키마 자동 생성
export const insertNoteSchema = createInsertSchema(notes)
export const selectNoteSchema = createSelectSchema(notes)

export type Note = typeof notes.$inferSelect
export type NewNote = typeof notes.$inferInsert
```

**RLS 정책** (Supabase에서 별도 적용):

```sql
-- RLS 활성화
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;

-- 정책 생성
CREATE POLICY "Users can view own notes" ON public.notes
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create own notes" ON public.notes
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own notes" ON public.notes
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own notes" ON public.notes
  FOR DELETE USING (auth.uid() = user_id);
```

### 프로젝트 구조

**Drizzle ORM 구조**:

-   Drizzle 설정: `drizzle.config.ts`
-   DB 연결: `lib/db/connection.ts`
-   스키마 정의: `lib/db/schema/notes.ts`
-   마이그레이션: `drizzle/`

**노트 관리**:

-   노트 생성 페이지: `app/notes/new/page.tsx`
-   노트 작성 컴포넌트: `components/notes/note-form.tsx`
-   노트 서버 액션: `lib/notes/actions.ts`
-   노트 DB 쿼리: `lib/notes/queries.ts`

### 환경 변수 요구사항

[Source: Story 1.1, 1.2, 1.3 - 이미 설정 완료]

-   ✅ `NEXT_PUBLIC_SUPABASE_URL`
-   ✅ `NEXT_PUBLIC_SUPABASE_ANON_KEY`
-   ✅ `SUPABASE_SERVICE_ROLE_KEY`

**새로 추가 필요**:

-   🆕 `DATABASE_URL` - Drizzle ORM용 직접 DB 연결

### 재사용 가능한 컴포넌트

-   `components/ui/button.tsx` - 저장/취소 버튼
-   `components/ui/input.tsx` - 제목 입력 필드
-   `components/ui/textarea.tsx` - 본문 입력 에리어 (새로 추가 필요)
-   `components/ui/label.tsx` - 폼 레이블
-   `components/ui/card.tsx` - 노트 폼 컨테이너

### UX/UI 고려사항

-   **모바일 반응형**: 작은 화면에서도 편리한 노트 작성
-   **접근성**: 키보드 네비게이션 및 스크린 리더 지원
-   **자동 포커스**: 페이지 로드 시 제목 필드에 자동 포커스
-   **저장 피드백**: 로딩 스피너 및 성공/실패 메시지

### Testing

#### 테스트 표준

[Source: docs/architecture.md#6-배포운영]

-   테스트 프레임워크: Jest + React Testing Library (추정)
-   테스트 파일 위치: `__tests__/` 또는 컴포넌트 옆에 `.test.tsx`

#### 노트 생성 테스트

-   노트 폼 렌더링 테스트
-   제목/본문 입력 테스트
-   폼 제출 및 저장 테스트
-   에러 핸들링 테스트
-   리다이렉트 동작 테스트

## Change Log

| Date       | Version | Description | Author           |
| ---------- | ------- | ----------- | ---------------- |
| 2025-09-13 | 1.0     | 스토리 생성 | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Cursor 환경)

### Debug Log References

1. **Drizzle Zod 스키마 오류 해결**

    - 오류: `'ZodString' 형식에 'title' 속성이 없습니다.`
    - 해결: `createInsertSchema` 콜백 파라미터 수정 (`schema => schema.title` → `z => z`)

2. **Server Action redirect 오류 해결**

    - 오류: `NEXT_REDIRECT` 예외가 try-catch에서 잡힘
    - 해결: `redirect()` 호출을 try-catch 블록 밖으로 이동

3. **강의용 마이그레이션 관리 방식 설정**
    - 문제: 수강생 환경에서 마이그레이션 파일과 메타데이터 충돌
    - 해결: `drizzle/` 전체를 `.gitignore`에 추가, `db:generate` → `db:migrate` 워크플로우 적용

### Completion Notes List

1. ✅ **Drizzle ORM 완전 설정**

    - 패키지 설치: `drizzle-orm`, `postgres`, `drizzle-kit`, `drizzle-zod`
    - 설정 파일: `drizzle.config.ts` with dotenv 로딩
    - 환경 변수: `DATABASE_URL` 추가

2. ✅ **데이터베이스 스키마 구현**

    - `notes` 테이블: id, user_id, title, content, created_at, updated_at
    - Zod 스키마 자동 생성 및 유효성 검증
    - RLS 정책 SQL 스크립트 생성

3. ✅ **UI 컴포넌트 구현**

    - `Textarea` 컴포넌트 추가 (shadcn/ui 스타일)
    - `NoteForm` 컴포넌트: 폼 제출, 로딩 상태, 에러 핸들링
    - 자동 포커스, 최대 길이 제한, 사용자 피드백

4. ✅ **Server Actions 구현**

    - `createNote`: 유효성 검증, 데이터베이스 저장, 리다이렉트
    - `getUserNotes`, `getNoteById`: 사용자별 노트 조회
    - 사용자 인증 및 권한 확인

5. ✅ **라우팅 및 네비게이션**

    - `/notes/new`: 노트 작성 페이지
    - `/notes`: 노트 목록 페이지 (빈 상태 포함)
    - 대시보드에서 노트 작성 페이지로 링크 연결

6. ✅ **강의용 환경 설정**
    - `.env.example` 업데이트 with `DATABASE_URL`
    - README.md에 상세한 설정 가이드 추가
    - 마이그레이션 충돌 해결 방안 문서화

### File List

**새로 생성된 파일:**

-   `drizzle.config.ts` - Drizzle ORM 설정
-   `lib/db/connection.ts` - 데이터베이스 연결
-   `lib/db/schema/notes.ts` - 노트 테이블 스키마
-   `lib/notes/actions.ts` - 노트 관련 Server Actions
-   `lib/notes/queries.ts` - 노트 조회 함수들
-   `components/ui/textarea.tsx` - 텍스트에리어 UI 컴포넌트
-   `components/notes/note-form.tsx` - 노트 작성 폼 컴포넌트
-   `app/notes/new/page.tsx` - 노트 작성 페이지
-   `app/notes/page.tsx` - 노트 목록 페이지
-   `supabase/migrations/0001_enable_rls_and_policies.sql` - RLS 정책 SQL

**수정된 파일:**

-   `package.json` - Drizzle 관련 스크립트 및 의존성 추가
-   `.env.local` - `DATABASE_URL` 추가
-   `.env.example` - 환경 변수 가이드 업데이트
-   `.gitignore` - `drizzle/` 폴더 제외
-   `README.md` - 프로젝트 설정 가이드 추가
-   `app/page.tsx` - 노트 작성 링크 추가

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
