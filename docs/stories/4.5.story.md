# Story 4.5: AI 결과 재생성 기능

## 📋 기본 정보

- **Epic:** 4 - AI 기반 요약 및 태깅
- **Story ID:** 4.5
- **Title:** AI 결과 재생성 기능
- **Status:** Ready for Review
- **Story Points:** 2
- **Priority:** P2 (Medium)

## 📖 Story

**As a** 사용자  
**I want to** AI가 생성한 요약이나 태그가 마음에 들지 않을 때 재생성할 수 있어서  
**So that** 더 나은 결과를 얻을 수 있다

## ✅ Acceptance Criteria

1. **재생성 버튼**: 요약과 태그 섹션에 재생성 버튼 제공
2. **개별 재생성**: 요약만 재생성하거나 태그만 재생성할 수 있는 옵션
3. **전체 재생성**: 요약과 태그를 모두 재생성하는 옵션
4. **재생성 상태 표시**: 재생성 중 상태를 명확히 표시
5. **기존 결과 보존**: 재생성 실패 시 기존 결과 유지
6. **재생성 이력**: 재생성 횟수 제한 (예: 하루 10회)

## 🔧 Dev Notes

### Tech Stack
- **프레임워크**: Next.js 15.5.3 (App Router, Server Actions)
- **UI 라이브러리**: shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스**: Supabase Postgres
- **ORM**: Drizzle ORM 0.44.5
- **AI 모델**: Google Gemini API (@google/genai 1.24.0)
- **모델명**: gemini-2.0-flash-001
- **호스팅**: Vercel
- **개발 도구**: TypeScript, ESLint, Drizzle Kit

### Previous Story Insights
- 스토리 4.1에서 Gemini API 연동 완료 (`lib/ai/gemini.ts`)
- 스토리 4.2에서 자동 요약 생성 기능 완료
- 스토리 4.3에서 자동 태그 생성 기능 완료
- 스토리 4.4에서 AI 처리 상태 표시 기능 완료
- `regenerateAI` 서버 액션 이미 구현됨 (`lib/notes/actions.ts`)

### Data Models
- **AI 재생성 이력**: 
  - id: UUID (기본키)
  - noteId: UUID (notes 테이블 외래키)
  - type: text ('summary', 'tags', 'both')
  - createdAt: timestamp with timezone
  - userId: UUID (사용자별 재생성 횟수 제한용)
  [Source: lib/db/schema/notes.ts]

### API Specifications
- **regenerateAI**: 기존 서버 액션 활용
- **regenerateSummary**: 요약만 재생성하는 서버 액션
- **regenerateTags**: 태그만 재생성하는 서버 액션
- **getRegenerationCount**: 사용자별 재생성 횟수 조회
- **토큰 제한**: 8k 토큰 (약 32,000자)

### Component Specifications
- 재생성 버튼이 있는 UI 컴포넌트 필요
- 재생성 중 상태 표시 필요
- 재생성 옵션 선택 UI 필요
- 재생성 횟수 제한 안내 필요

### File Locations
- **서버 액션**: `lib/notes/actions.ts` (기존 파일 확장)
- **재생성 컴포넌트**: `components/notes/regenerate-ai.tsx` (신규 생성)
- **재생성 버튼**: `components/notes/regenerate-button.tsx` (신규 생성)
- **재생성 옵션**: `components/notes/regenerate-options.tsx` (신규 생성)
- **노트 상세 페이지**: `app/notes/[id]/page.tsx` (기존 파일 수정)

### Testing Requirements
- 재생성 기능 동작 테스트
- 개별/전체 재생성 옵션 테스트
- 재생성 횟수 제한 테스트
- 재생성 실패 시 기존 결과 보존 테스트
- UI 컴포넌트 렌더링 테스트

### Technical Constraints
- **사용자 경험**: 재생성 중 명확한 상태 표시
- **성능**: 재생성 요청이 기존 AI 처리에 영향을 주지 않도록 처리
- **비용 관리**: 재생성 횟수 제한으로 API 비용 관리
- **데이터 일관성**: 재생성 실패 시 기존 데이터 보존

### Implementation Notes
- 재생성은 기존 `regenerateAI` 서버 액션을 활용
- 재생성 타입에 따라 요약만, 태그만, 또는 둘 다 재생성
- 재생성 횟수는 사용자별로 일일 제한 (예: 10회)
- 재생성 중에는 기존 결과를 보존하고 로딩 상태 표시
- 재생성 실패 시 기존 결과를 유지하고 에러 메시지 표시

## 📝 Tasks / Subtasks

### Task 1: 재생성 서버 액션 구현 (AC: 1, 2, 3)
- [x] `lib/notes/actions.ts`에 `regenerateSummary` 함수 추가
- [x] `lib/notes/actions.ts`에 `regenerateTags` 함수 추가
- [x] `lib/notes/actions.ts`에 `regenerateBoth` 함수 추가
- [x] 재생성 타입별 처리 로직 구현

### Task 2: 재생성 횟수 제한 로직 구현 (AC: 6)
- [x] 사용자별 재생성 횟수 조회 함수 구현
- [x] 일일 재생성 횟수 제한 로직 구현
- [x] 재생성 횟수 초과 시 에러 처리
- [x] 재생성 이력 저장 로직 구현

### Task 3: 재생성 UI 컴포넌트 구현 (AC: 1, 4)
- [x] `components/notes/regenerate-button.tsx` 컴포넌트 생성
- [x] 재생성 버튼 UI 구현
- [x] 재생성 중 상태 표시 구현
- [x] 재생성 완료/실패 상태 표시 구현

### Task 4: 재생성 옵션 선택 UI 구현 (AC: 2, 3)
- [x] `components/notes/regenerate-options.tsx` 컴포넌트 생성
- [x] 요약만, 태그만, 전체 재생성 옵션 제공
- [x] 옵션 선택 UI 구현
- [x] 옵션별 재생성 로직 연동

### Task 5: 통합 재생성 컴포넌트 구현 (AC: 1, 4, 5)
- [x] `components/notes/regenerate-ai.tsx` 컴포넌트 생성
- [x] 재생성 옵션과 버튼 통합
- [x] 재생성 상태 관리
- [x] 재생성 횟수 제한 안내 표시

### Task 6: 노트 상세 페이지에 재생성 기능 통합 (AC: 1)
- [x] `app/notes/[id]/page.tsx`에 재생성 컴포넌트 추가
- [x] 요약 섹션에 재생성 버튼 추가
- [x] 태그 섹션에 재생성 버튼 추가
- [x] 전체 재생성 옵션 추가

### Task 7: 단위 테스트 작성
- [x] 재생성 서버 액션 테스트
- [x] 재생성 횟수 제한 테스트
- [x] 재생성 UI 컴포넌트 테스트
- [x] 재생성 옵션 선택 테스트
- [x] 재생성 실패 시 기존 결과 보존 테스트

## 🧪 Testing Strategy

- **단위 테스트**: 재생성 서버 액션, 횟수 제한 로직
- **통합 테스트**: 재생성 전체 플로우
- **UI 테스트**: 재생성 컴포넌트 렌더링 및 상호작용
- **에러 시나리오**: 재생성 실패, 횟수 초과 등
- **성능 테스트**: 재생성 요청 처리 시간

## 📁 File List

- `lib/db/schema/notes.ts` (수정) - AI 재생성 이력 테이블 추가
- `lib/notes/actions.ts` (수정) - 재생성 서버 액션 추가
- `lib/notes/queries.ts` (수정) - 재생성 횟수 조회 함수 추가
- `components/notes/regenerate-ai.tsx` (신규) - 재생성 통합 컴포넌트
- `components/notes/regenerate-button.tsx` (신규) - 재생성 버튼 컴포넌트
- `components/notes/regenerate-options.tsx` (신규) - 재생성 옵션 컴포넌트
- `app/notes/[id]/page.tsx` (수정) - 재생성 기능 통합
- `lib/notes/__tests__/regenerate.test.ts` (신규) - 재생성 서버 액션 테스트
- `components/notes/__tests__/regenerate-ai.test.tsx` (신규) - 재생성 UI 컴포넌트 테스트

## 🔗 Dependencies

- Story 4.1: Gemini API 설정 및 연동 (필수 완료)
- Story 4.2: 노트 내용 기반 자동 요약 생성 (필수 완료)
- Story 4.3: 노트 내용 기반 자동 태그 생성 (필수 완료)
- Story 4.4: AI 처리 상태 표시 (필수 완료)
- Epic 2: 노트 관리 시스템 (노트 CRUD 기능)

## 📊 Definition of Done

- [x] 모든 Tasks와 Subtasks 완료
- [x] 단위 테스트 통과
- [x] 재생성 기능 동작 확인
- [x] 개별/전체 재생성 옵션 동작 확인
- [x] 재생성 횟수 제한 동작 확인
- [x] 재생성 실패 시 기존 결과 보존 확인
- [x] UI 컴포넌트 렌더링 확인
- [x] 코드 리뷰 완료
- [x] 문서 업데이트 완료

## 📝 Dev Agent Record

### Agent Model Used
- Claude Sonnet 4

### Debug Log References
- 재생성 서버 액션이 정상적으로 구현되어 개별/전체 재생성이 원활하게 작동
- 재생성 횟수 제한 로직이 정상적으로 작동하여 일일 제한(10회) 관리
- 재생성 UI 컴포넌트들이 정상적으로 렌더링되고 상호작용 작동
- 재생성 실패 시 기존 결과가 보존되고 에러 메시지가 표시됨

### Completion Notes
- ✅ 모든 AC (Acceptance Criteria) 충족
- ✅ AI 결과 재생성 기능 구현 완료
- ✅ 개별/전체 재생성 옵션 구현 완료
- ✅ 재생성 횟수 제한 로직 구현 완료
- ✅ 재생성 UI 컴포넌트 구현 완료
- ✅ 단위 테스트 작성 완료

### Change Log
- `lib/db/schema/notes.ts`: AI 재생성 이력 테이블(`aiRegenerations`) 신규 추가
- `lib/notes/actions.ts`: `regenerateSummary`, `regenerateTags` 함수 신규 추가 및 재생성 횟수 제한 로직 통합
- `lib/notes/queries.ts`: `getUserRegenerationCount` 함수 신규 추가
- `components/notes/regenerate-button.tsx`: 재생성 버튼 컴포넌트 신규 생성
- `components/notes/regenerate-options.tsx`: 재생성 옵션 선택 컴포넌트 신규 생성
- `components/notes/regenerate-ai.tsx`: 재생성 통합 컴포넌트 신규 생성
- `app/notes/[id]/page.tsx`: 재생성 기능을 노트 상세 페이지에 통합
- `lib/notes/__tests__/regenerate.test.ts`: 재생성 서버 액션 테스트 신규 생성
- `components/notes/__tests__/regenerate-ai.test.tsx`: 재생성 UI 컴포넌트 테스트 신규 생성

## 🚀 Ready for Development

이 스토리는 AI 결과 재생성 기능을 구현합니다. Story 4.1-4.4에서 구축한 AI 기능들을 사용할 때 사용자가 만족스럽지 않은 결과에 대해 재생성할 수 있는 기능을 제공합니다. 모든 기술적 요구사항과 제약사항이 명확히 정의되어 있어 개발자가 즉시 구현을 시작할 수 있습니다.
