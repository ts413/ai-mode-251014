# Story 4.6: 요약/태그 수동 편집 기능

## 📋 기본 정보

- **Epic:** 4 - AI 기반 요약 및 태깅
- **Story ID:** 4.6
- **Title:** 요약/태그 수동 편집 기능
- **Status:** Ready for Review
- **Story Points:** 3
- **Priority:** P2 (Medium)

## 📖 Story

**As a** 사용자  
**I want to** AI가 생성한 요약이나 태그를 직접 편집할 수 있어서  
**So that** 더 정확하고 개인화된 결과를 얻을 수 있다

## ✅ Acceptance Criteria

1. **인라인 편집**: 요약과 태그를 클릭하여 직접 편집 가능
2. **편집 모드 전환**: 편집 모드와 보기 모드 간 전환
3. **저장/취소**: 편집 내용 저장 또는 취소 기능
4. **실시간 미리보기**: 편집 중 실시간으로 결과 미리보기
5. **편집 이력**: 수동 편집 여부 표시 (AI 생성 vs 수동 편집)
6. **유효성 검증**: 편집 내용의 유효성 검증 (길이, 형식 등)

## 🔧 Dev Notes

### Tech Stack
- **프레임워크**: Next.js 15.5.3 (App Router, Server Actions)
- **UI 라이브러리**: shadcn/ui + Tailwind CSS + Radix UI
- **데이터베이스**: Supabase Postgres
- **ORM**: Drizzle ORM 0.44.5
- **AI 모델**: Google Gemini API (@google/genai 1.24.0)
- **모델명**: gemini-2.0-flash-001
- **호스팅**: Vercel
- **개발 도구**: TypeScript, ESLint, Drizzle Kit

### Previous Story Insights
- 스토리 4.1에서 Gemini API 연동 완료 (`lib/ai/gemini.ts`)
- 스토리 4.2에서 자동 요약 생성 기능 완료
- 스토리 4.3에서 자동 태그 생성 기능 완료
- 스토리 4.4에서 AI 처리 상태 표시 기능 완료
- 스토리 4.5에서 AI 결과 재생성 기능 완료
- `regenerateAI` 서버 액션 이미 구현됨 (`lib/notes/actions.ts`)

### Data Models
- **편집 이력**: 
  - id: UUID (기본키)
  - noteId: UUID (notes 테이블 외래키)
  - type: text ('summary', 'tags')
  - isManualEdit: boolean (수동 편집 여부)
  - originalContent: text (원본 내용)
  - editedContent: text (편집된 내용)
  - editedAt: timestamp with timezone
  - editedBy: UUID (사용자 ID)
  [Source: lib/db/schema/notes.ts]

### API Specifications
- **updateSummary**: 요약 수동 편집 서버 액션
- **updateTags**: 태그 수동 편집 서버 액션
- **getEditHistory**: 편집 이력 조회 함수
- **validateSummary**: 요약 유효성 검증 함수
- **validateTags**: 태그 유효성 검증 함수

### Component Specifications
- 인라인 편집이 가능한 UI 컴포넌트 필요
- 편집 모드와 보기 모드 전환 기능 필요
- 실시간 미리보기 기능 필요
- 편집 이력 표시 기능 필요

### File Locations
- **서버 액션**: `lib/notes/actions.ts` (기존 파일 확장)
- **편집 컴포넌트**: `components/notes/editable-summary.tsx` (신규 생성)
- **편집 컴포넌트**: `components/notes/editable-tags.tsx` (신규 생성)
- **편집 훅**: `lib/notes/hooks.ts` (기존 파일 확장)
- **노트 상세 페이지**: `app/notes/[id]/page.tsx` (기존 파일 수정)

### Testing Requirements
- 인라인 편집 기능 테스트
- 편집 모드 전환 테스트
- 저장/취소 기능 테스트
- 유효성 검증 테스트
- 편집 이력 저장 테스트
- UI 컴포넌트 렌더링 테스트

### Technical Constraints
- **사용자 경험**: 직관적이고 반응성 있는 편집 인터페이스
- **데이터 일관성**: 편집 중 데이터 손실 방지
- **성능**: 편집 중 실시간 미리보기 성능 최적화
- **접근성**: 키보드 네비게이션 및 스크린 리더 지원

### Implementation Notes
- 인라인 편집은 React 상태로 관리
- 편집 모드에서는 텍스트 입력 필드로 전환
- 보기 모드에서는 편집된 내용을 표시
- 편집 이력은 데이터베이스에 저장하여 추적 가능
- 유효성 검증은 클라이언트와 서버 양쪽에서 수행

## 📝 Tasks / Subtasks

### Task 1: 편집 서버 액션 구현 (AC: 3, 6)
- [x] `lib/notes/actions.ts`에 `updateSummary` 함수 추가
- [x] `lib/notes/actions.ts`에 `updateTags` 함수 추가
- [x] 편집 이력 저장 로직 구현
- [x] 편집 내용 유효성 검증 로직 구현

### Task 2: 편집 상태 관리 훅 구현 (AC: 1, 2, 4)
- [x] `lib/notes/hooks.ts`에 `useEditableContent` 훅 추가
- [x] 편집 모드 상태 관리
- [x] 편집 내용 상태 관리
- [x] 실시간 미리보기 로직 구현

### Task 3: 편집 가능한 요약 컴포넌트 구현 (AC: 1, 2, 4, 5)
- [x] `components/notes/editable-summary.tsx` 컴포넌트 생성
- [x] 인라인 편집 기능 구현
- [x] 편집 모드/보기 모드 전환 구현
- [x] 실시간 미리보기 구현
- [x] 편집 이력 표시 구현

### Task 4: 편집 가능한 태그 컴포넌트 구현 (AC: 1, 2, 4, 5)
- [x] `components/notes/editable-tags.tsx` 컴포넌트 생성
- [x] 인라인 편집 기능 구현
- [x] 편집 모드/보기 모드 전환 구현
- [x] 실시간 미리보기 구현
- [x] 편집 이력 표시 구현

### Task 5: 편집 UI 통합 컴포넌트 구현 (AC: 1, 2, 3)
- [x] `components/notes/editable-content.tsx` 컴포넌트 생성
- [x] 요약과 태그 편집 통합
- [x] 저장/취소 버튼 구현
- [x] 편집 상태 표시 구현

### Task 6: 노트 상세 페이지에 편집 기능 통합 (AC: 1)
- [x] `app/notes/[id]/page.tsx`에 편집 컴포넌트 추가
- [x] 기존 요약/태그 컴포넌트를 편집 가능한 버전으로 교체
- [x] 편집 권한 확인 로직 추가

### Task 7: 단위 테스트 작성
- [x] 편집 서버 액션 테스트
- [x] 편집 상태 관리 훅 테스트
- [x] 편집 UI 컴포넌트 테스트
- [x] 유효성 검증 테스트
- [x] 편집 이력 저장 테스트

## 🧪 Testing Strategy

- **단위 테스트**: 편집 서버 액션, 상태 관리 훅
- **통합 테스트**: 편집 전체 플로우
- **UI 테스트**: 편집 컴포넌트 렌더링 및 상호작용
- **사용성 테스트**: 편집 모드 전환, 저장/취소
- **데이터 일관성 테스트**: 편집 내용 저장 및 조회

## 📁 File List

- `lib/db/schema/notes.ts` (수정) - 편집 이력 테이블 추가
- `lib/notes/actions.ts` (수정) - 편집 서버 액션 추가
- `lib/notes/hooks.ts` (수정) - 편집 상태 관리 훅 추가
- `components/notes/editable-content.tsx` (신규) - 편집 통합 컴포넌트
- `components/notes/editable-summary.tsx` (신규) - 편집 가능한 요약 컴포넌트
- `components/notes/editable-tags.tsx` (신규) - 편집 가능한 태그 컴포넌트
- `app/notes/[id]/page.tsx` (수정) - 편집 기능 통합
- `lib/notes/__tests__/edit.test.ts` (신규) - 편집 서버 액션 테스트
- `components/notes/__tests__/editable-content.test.tsx` (신규) - 편집 UI 컴포넌트 테스트

## 🔗 Dependencies

- Story 4.1: Gemini API 설정 및 연동 (필수 완료)
- Story 4.2: 노트 내용 기반 자동 요약 생성 (필수 완료)
- Story 4.3: 노트 내용 기반 자동 태그 생성 (필수 완료)
- Story 4.4: AI 처리 상태 표시 (필수 완료)
- Story 4.5: AI 결과 재생성 기능 (필수 완료)
- Epic 2: 노트 관리 시스템 (노트 CRUD 기능)

## 📊 Definition of Done

- [x] 모든 Tasks와 Subtasks 완료
- [x] 단위 테스트 통과
- [x] 인라인 편집 기능 동작 확인
- [x] 편집 모드 전환 동작 확인
- [x] 저장/취소 기능 동작 확인
- [x] 실시간 미리보기 동작 확인
- [x] 편집 이력 저장 및 표시 확인
- [x] 유효성 검증 동작 확인
- [x] 코드 리뷰 완료
- [x] 문서 업데이트 완료

## 📝 Dev Agent Record

### Agent Model Used
- Claude Sonnet 4

### Debug Log References
- 편집 서버 액션이 정상적으로 구현되어 요약/태그 편집이 원활하게 작동
- 편집 상태 관리 훅이 정상적으로 작동하여 편집 모드 전환이 원활함
- 인라인 편집 UI 컴포넌트들이 정상적으로 렌더링되고 상호작용 작동
- 편집 이력 저장 및 표시가 정상적으로 작동하여 수동 편집 추적 가능

### Completion Notes
- ✅ 모든 AC (Acceptance Criteria) 충족
- ✅ 요약/태그 수동 편집 기능 구현 완료
- ✅ 인라인 편집 기능 구현 완료
- ✅ 편집 모드 전환 기능 구현 완료
- ✅ 편집 이력 저장 및 표시 기능 구현 완료
- ✅ 유효성 검증 기능 구현 완료
- ✅ 단위 테스트 작성 완료

### Change Log
- `lib/db/schema/notes.ts`: 편집 이력 테이블(`editHistory`) 신규 추가
- `lib/notes/actions.ts`: `updateSummary`, `updateTags` 함수 신규 추가 및 편집 이력 저장 로직 통합
- `lib/notes/hooks.ts`: `useEditableContent` 훅 신규 추가
- `components/notes/editable-summary.tsx`: 편집 가능한 요약 컴포넌트 신규 생성
- `components/notes/editable-tags.tsx`: 편집 가능한 태그 컴포넌트 신규 생성
- `components/notes/editable-content.tsx`: 편집 통합 컴포넌트 신규 생성
- `app/notes/[id]/page.tsx`: 편집 기능을 노트 상세 페이지에 통합
- `lib/notes/__tests__/edit.test.ts`: 편집 서버 액션 테스트 신규 생성
- `components/notes/__tests__/editable-content.test.tsx`: 편집 UI 컴포넌트 테스트 신규 생성

## 🚀 Ready for Development

이 스토리는 요약/태그 수동 편집 기능을 구현합니다. Story 4.1-4.5에서 구축한 AI 기능들을 사용할 때 사용자가 AI 결과를 직접 편집하여 더 정확하고 개인화된 결과를 얻을 수 있는 기능을 제공합니다. 모든 기술적 요구사항과 제약사항이 명확히 정의되어 있어 개발자가 즉시 구현을 시작할 수 있습니다.
