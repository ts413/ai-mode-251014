# Story 2.5: 노트 검색 및 필터링

## Status

Ready for Review

## Story

**As a** 로그인한 사용자,
**I want** 많은 노트 중에서 원하는 노트를 빠르게 찾을 수 있는 검색 및 필터링 기능,
**so that** 효율적으로 노트를 관리하고 필요한 정보에 빠르게 접근할 수 있다.

## Acceptance Criteria

1. 노트 목록 페이지에 검색 입력 필드가 표시되어야 한다
2. 검색어를 입력하면 제목과 본문에서 실시간으로 검색되어야 한다 (ILIKE 패턴 매칭)
3. 검색 결과는 제목 우선 → 본문 순으로 정렬되어야 한다
4. 검색어가 하이라이트되어 표시되어야 한다
5. 빈 검색어일 때는 전체 노트가 표시되어야 한다
6. 검색 결과가 없을 때 적절한 메시지가 표시되어야 한다
7. 검색과 기존 정렬 기능이 함께 작동해야 한다
8. URL에 검색어가 반영되어 북마크 및 공유가 가능해야 한다
9. 검색 입력 필드에 자동완성 기능이 있어야 한다
10. 모바일에서도 검색 기능이 원활하게 작동해야 한다

## Tasks / Subtasks

-   [x] 검색 기능 백엔드 구현 (AC: 2, 3, 5)
    -   [x] ILIKE 기반 검색 쿼리 함수 구현
    -   [x] 제목 우선 정렬 로직 추가
    -   [x] trigram 인덱스로 ILIKE 성능 최적화
    -   [x] 페이지네이션과 검색 통합
-   [x] 검색 UI 컴포넌트 구현 (AC: 1, 4, 6, 10)
    -   [x] 검색 입력 필드 컴포넌트
    -   [x] 검색어 하이라이트 기능
    -   [x] 검색 결과 없음 상태 UI
    -   [x] 반응형 검색 인터페이스
-   [x] 실시간 검색 기능 구현 (AC: 2, 9)
    -   [x] debounce 기반 검색 로직
    -   [x] 검색 중 로딩 상태 표시
    -   [x] 자동완성 기능 구현
    -   [x] 검색 히스토리 관리
-   [x] 검색과 정렬 통합 (AC: 7, 8)
    -   [x] URL 상태 관리 (search + sort)
    -   [x] 검색 + 정렬 조합 로직
    -   [x] 브라우저 히스토리 관리
    -   [x] 검색 결과 페이지네이션

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **UI:** shadcn/ui + Tailwind + Radix UI
-   **DB/ORM:** Drizzle ORM + Supabase (PostgreSQL)
-   **상태 관리:** React useState/useEffect (클라이언트 상태)

### 검색 기능 설계 (MVP)

**데이터베이스 검색 (ILIKE 활용):**

```sql
-- 간단한 ILIKE 패턴 매칭
SELECT *
FROM notes
WHERE user_id = $1
  AND (
    title ILIKE '%' || $2 || '%'
    OR content ILIKE '%' || $2 || '%'
  )
ORDER BY
  CASE WHEN title ILIKE '%' || $2 || '%' THEN 1 ELSE 2 END,
  updated_at DESC
```

**검색 쿼리 함수:**

```typescript
export async function searchUserNotes({
    query,
    page,
    limit,
    sort
}: {
    query: string
    page: number
    limit: number
    sort: NotesSort
}): Promise<{ notes: Note[]; totalCount: number }> {
    // 검색어가 없으면 기본 조회
    if (!query.trim()) {
        return getUserNotesPaginated({ page, limit, sort })
    }

    // ILIKE 기반 검색 실행
    const searchPattern = `%${query}%`
    // Drizzle ORM을 사용한 ILIKE 검색 구현
    // ...
}
```

### 실시간 검색 설계

**Debounce 전략:**

```typescript
const SEARCH_DELAY = 300 // 300ms 대기

const debouncedSearch = useCallback(
    debounce((searchQuery: string) => {
        // URL 업데이트 및 검색 실행
        router.replace(
            `/notes?search=${encodeURIComponent(searchQuery)}&sort=${sort}`
        )
    }, SEARCH_DELAY),
    [router, sort]
)
```

**검색 상태 관리:**

```typescript
interface SearchState {
    query: string
    isSearching: boolean
    results: Note[]
    totalCount: number
    hasSearched: boolean
}
```

### 검색어 하이라이트 설계

**하이라이트 컴포넌트:**

```typescript
function HighlightText({
    text,
    highlight
}: {
    text: string
    highlight: string
}) {
    if (!highlight.trim()) return <>{text}</>

    const regex = new RegExp(`(${highlight})`, 'gi')
    const parts = text.split(regex)

    return (
        <>
            {parts.map((part, index) =>
                regex.test(part) ? (
                    <mark key={index} className="bg-yellow-200 px-1 rounded">
                        {part}
                    </mark>
                ) : (
                    part
                )
            )}
        </>
    )
}
```

### 자동완성 기능 설계

**검색 히스토리 관리:**

```typescript
// localStorage에 검색 히스토리 저장
const SEARCH_HISTORY_KEY = 'note-search-history'
const MAX_HISTORY_SIZE = 10

function saveSearchHistory(query: string) {
    const history = getSearchHistory()
    const newHistory = [query, ...history.filter(item => item !== query)].slice(
        0,
        MAX_HISTORY_SIZE
    )

    localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(newHistory))
}
```

**자동완성 UI:**

```typescript
function SearchAutocomplete({
    suggestions,
    onSelect
}: {
    suggestions: string[]
    onSelect: (suggestion: string) => void
}) {
    return (
        <div className="absolute top-full left-0 right-0 bg-white border rounded-md shadow-lg z-10">
            {suggestions.map((suggestion, index) => (
                <button
                    key={index}
                    className="w-full text-left px-3 py-2 hover:bg-gray-100"
                    onClick={() => onSelect(suggestion)}
                >
                    {suggestion}
                </button>
            ))}
        </div>
    )
}
```

### 성능 최적화 (MVP)

**데이터베이스 인덱스:**

```sql
-- ILIKE 검색 성능 향상을 위한 인덱스
CREATE INDEX idx_notes_title_text ON notes USING gin(title gin_trgm_ops);
CREATE INDEX idx_notes_content_text ON notes USING gin(content gin_trgm_ops);

-- 사용자별 검색 성능 향상
CREATE INDEX idx_notes_user_updated ON notes (user_id, updated_at DESC);

-- trigram 확장 활성화 (ILIKE 성능 향상)
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

**클라이언트 최적화:**

-   debounce로 불필요한 API 호출 방지
-   검색 결과 캐싱 (React Query 고려)
-   무한 스크롤 또는 페이지네이션
-   검색어 입력 시 이전 요청 취소

### URL 상태 관리

**검색 URL 구조:**

```
/notes?search=검색어&sort=newest&page=1
/notes?search=React&sort=title&page=2
```

**상태 동기화:**

```typescript
// URL → 상태
const searchParams = useSearchParams()
const initialSearch = searchParams.get('search') || ''

// 상태 → URL
const updateURL = (search: string, sort: string, page: number) => {
    const params = new URLSearchParams()
    if (search) params.set('search', search)
    params.set('sort', sort)
    params.set('page', page.toString())

    router.replace(`/notes?${params.toString()}`)
}
```

### 접근성 고려사항

-   **스크린 리더**: 검색 결과 수 안내
-   **키보드 네비게이션**: 자동완성 목록 화살표 키 지원
-   **포커스 관리**: 검색 입력 필드 적절한 포커스
-   **ARIA 레이블**: 검색 상태 및 결과 명확히 전달

### 에러 처리

**검색 에러 시나리오:**

-   네트워크 오류: 재시도 버튼 제공
-   서버 오류: 기본 목록으로 폴백
-   검색어 너무 짧음: 최소 길이 안내
-   검색 결과 없음: 대안 제시

### 사용자 경험 최적화

**검색 플로우:**

1. 검색어 입력 → debounce 대기
2. 검색 중 표시 → 로딩 스피너
3. 결과 표시 → 하이라이트 + 개수
4. 빈 결과 → 도움말 또는 제안

**마이크로 인터랙션:**

-   검색 입력 시 부드러운 애니메이션
-   결과 로딩 중 스켈레톤 UI
-   검색어 하이라이트 색상 효과
-   자동완성 hover 효과

### 재사용 가능한 컴포넌트

-   `components/notes/search-input.tsx` - 검색 입력 필드 (새로 추가)
-   `components/notes/search-results.tsx` - 검색 결과 표시 (새로 추가)
-   `components/notes/highlight-text.tsx` - 텍스트 하이라이트 (새로 추가)
-   `components/notes/search-autocomplete.tsx` - 자동완성 (새로 추가)

### 프로젝트 구조

**새로 추가될 파일:**

-   `components/notes/search-input.tsx` - 검색 입력 컴포넌트
-   `components/notes/search-results.tsx` - 검색 결과 컴포넌트
-   `components/notes/highlight-text.tsx` - 하이라이트 컴포넌트
-   `components/notes/search-autocomplete.tsx` - 자동완성 컴포넌트
-   `lib/notes/search.ts` - 검색 관련 유틸리티
-   `lib/hooks/useSearch.ts` - 검색 커스텀 훅

**수정될 파일:**

-   `lib/notes/queries.ts` - 검색 쿼리 함수 추가
-   `app/notes/page.tsx` - 검색 기능 통합
-   `components/notes/notes-list.tsx` - 검색 결과 표시 대응

### Testing

#### 단위 테스트

-   검색 쿼리 함수 테스트
-   하이라이트 로직 테스트
-   debounce 동작 테스트

#### 통합 테스트

-   검색 → 결과 표시 플로우
-   검색 + 정렬 조합 테스트
-   URL 상태 동기화 테스트

#### E2E 테스트

-   전체 검색 워크플로우
-   자동완성 기능 테스트
-   모바일 검색 경험 테스트

### 향후 확장 고려사항

-   **전문 검색**: PostgreSQL Full-Text Search 도입
-   **고급 검색**: 날짜 범위, 태그 필터
-   **검색 분석**: 인기 검색어, 검색 패턴
-   **AI 검색**: 의미 기반 검색, 검색 제안
-   **검색 내 검색**: 검색 결과 내에서 재검색

## Change Log

| Date       | Version | Description                                | Author                    |
| ---------- | ------- | ------------------------------------------ | ------------------------- |
| 2025-09-14 | 1.0     | 스토리 생성                                | Dev Agent Claude 4 Sonnet |
| 2025-09-14 | 1.1     | MVP 범위로 축소 (ILIKE 기반 검색으로 변경) | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude 4 Sonnet

### Debug Log References

N/A

### Completion Notes List

- ✅ ILIKE 기반 검색 쿼리 구현 완료
- ✅ 제목 우선 정렬 로직 추가 완료  
- ✅ 실시간 검색 UI 컴포넌트 구현 완료
- ✅ 검색어 하이라이트 기능 구현 완료
- ✅ 자동완성 및 검색 히스토리 기능 구현 완료
- ✅ URL 상태 관리 및 페이지네이션 통합 완료
- ✅ 반응형 디자인 적용 완료

### File List

**새로 생성된 파일:**
- `lib/notes/search.ts` - 검색 관련 유틸리티 함수
- `components/notes/search-input.tsx` - 검색 입력 컴포넌트
- `components/notes/highlight-text.tsx` - 텍스트 하이라이트 컴포넌트
- `components/notes/search-results.tsx` - 검색 결과 표시 컴포넌트
- `lib/utils/debounce.ts` - debounce 훅

**수정된 파일:**
- `lib/notes/queries.ts` - 검색 쿼리 함수 추가
- `app/notes/page.tsx` - 검색 기능 통합

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
