# Story 2.2: 노트 목록 조회, 페이지네이션 및 정렬

## Status

Done

## Story

**As a** 로그인한 사용자,
**I want** 내가 작성한 노트들을 목록으로 조회하고, 페이지네이션과 정렬 기능을 사용할 수 있는 기능,
**so that** 많은 노트들을 효율적으로 탐색하고 관리할 수 있다.

## Acceptance Criteria

1. 사용자의 모든 노트가 카드 형태로 목록 표시되어야 한다
2. 노트 카드에는 제목, 본문 미리보기, 작성일시가 포함되어야 한다
3. 노트 목록이 10개 이상일 때 페이지네이션이 표시되어야 한다
4. 페이지당 최대 12개의 노트가 표시되어야 한다
5. 정렬 옵션이 제공되어야 한다 (최신순, 오래된순, 제목순)
6. 기본 정렬은 "최신순" (updated_at DESC)이어야 한다
7. 노트가 없을 때 빈 상태 UI가 표시되어야 한다
8. 로딩 상태가 표시되어야 한다
9. 노트 카드 클릭 시 상세 페이지로 이동해야 한다
10. 반응형 디자인으로 모바일에서도 최적화되어야 한다

## Tasks / Subtasks

-   [x] 노트 목록 조회 API 개선 (AC: 1, 2, 3, 4)
    -   [x] 페이지네이션 파라미터 추가 (offset, limit)
    -   [x] 정렬 파라미터 추가 (sortBy, sortOrder)
    -   [x] 전체 노트 수 카운트 반환
    -   [x] Server Action 또는 API Route 구현 (서버 컴포넌트에서 서버측 쿼리 활용)
-   [x] 노트 목록 페이지 개선 (AC: 1, 2, 7, 8, 10)
    -   [x] 노트 카드 표시 (제목 2줄, 본문 미리보기)
    -   [x] 본문 미리보기 로직 (150자 제한)
    -   [x] 작성일시 포매팅 (상대시간 표시)
    -   [x] 반응형 그리드 레이아웃 구현
    -   [x] 로딩 스켈레톤 컴포넌트
-   [x] 페이지네이션 컴포넌트 구현 (AC: 3, 4)
    -   [x] 이전/다음 버튼 및 페이지 번호 표시
    -   [x] URL 파라미터와 동기화
    -   [x] 페이지 변경 시 스크롤 최상단 이동
-   [x] 정렬 기능 구현 (AC: 5, 6)
    -   [x] 정렬 드롭다운 컴포넌트
    -   [x] 정렬 옵션: 최신순, 오래된순, 제목순
    -   [x] URL 파라미터와 동기화
    -   [x] 정렬 변경 시 첫 페이지로 이동
-   [x] 노트 상세 페이지 네비게이션 (AC: 9)
    -   [x] `/notes/[id]` 라우트 생성
    -   [x] 노트 카드 클릭 이벤트 처리
    -   [x] 브라우저 히스토리 관리

## Dev Notes

### 이전 스토리 인사이트

[Source: Story 2.1 Dev Agent Records]

-   ✅ 노트 목록 기본 구조 이미 구현됨 (`app/notes/page.tsx`)
-   ✅ `getUserNotes()` 함수 기본 형태 존재 (`lib/notes/queries.ts`)
-   ✅ Drizzle ORM 설정 완료
-   ✅ 빈 상태 UI 이미 구현됨

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **UI:** shadcn/ui + Tailwind + Radix UI
-   **DB/ORM:** Drizzle ORM + Supabase (PostgreSQL)

### 페이지네이션 설계

**URL 파라미터 구조:**

```
/notes?page=1&sort=newest
/notes?page=2&sort=title
/notes?page=3&sort=oldest
```

**데이터베이스 쿼리 최적화:**

```typescript
// 효율적인 페이지네이션을 위한 쿼리
const notes = await db
    .select()
    .from(notes)
    .where(eq(notes.userId, userId))
    .orderBy(getSortOrder(sortBy))
    .limit(NOTES_PER_PAGE)
    .offset((page - 1) * NOTES_PER_PAGE)

const totalCount = await db
    .select({ count: count() })
    .from(notes)
    .where(eq(notes.userId, userId))
```

### UI/UX 고려사항

**노트 카드 디자인:**

-   **제목**: 2줄 제한, 말줄임(...) 처리
-   **본문 미리보기**: 3줄 제한, 150자 제한
-   **메타 정보**: 작성일시, 수정일시 (상대시간)
-   **호버 효과**: 카드 elevation 변화
-   **클릭 영역**: 전체 카드

**정렬 옵션:**

-   **최신순**: `updated_at DESC` (기본값)
-   **오래된순**: `updated_at ASC`
-   **제목순**: `title ASC`

**반응형 브레이크포인트:**

-   **모바일**: 1열 (sm 이하)
-   **태블릿**: 2열 (md)
-   **데스크톱**: 3열 (lg)
-   **와이드**: 4열 (xl 이상)

### 성능 최적화

**데이터베이스 인덱스:**

```sql
-- 이미 생성됨 (Story 2.1)
CREATE INDEX idx_notes_user_id ON notes (user_id);
CREATE INDEX idx_notes_updated_at ON notes (updated_at DESC);

-- 추가 필요
CREATE INDEX idx_notes_title ON notes (title);
CREATE INDEX idx_notes_user_id_updated_at ON notes (user_id, updated_at DESC);
```

**클라이언트 최적화:**

-   이미지 레이지 로딩 (미래 확장)
-   가상화 스크롤 (노트 수가 매우 많을 때)
-   캐시 전략 (React Query 또는 SWR 고려)

### 재사용 가능한 컴포넌트

-   `components/ui/pagination.tsx` - 페이지네이션 (새로 추가)
-   `components/ui/select.tsx` - 정렬 드롭다운 (새로 추가)
-   `components/notes/note-card.tsx` - 노트 카드 (새로 추가)
-   `components/notes/notes-grid.tsx` - 노트 그리드 레이아웃 (새로 추가)
-   `components/ui/skeleton.tsx` - 로딩 스켈레톤 (새로 추가)

### 접근성 고려사항

-   **키보드 네비게이션**: Tab으로 카드 간 이동
-   **스크린 리더**: 적절한 aria-label, role 속성
-   **포커스 관리**: 페이지 변경 시 포커스 이동
-   **색상 대비**: WCAG 2.1 AA 준수

### URL 상태 관리

**Next.js App Router 활용:**

```typescript
// searchParams 활용
export default function NotesPage({
    searchParams
}: {
    searchParams: { page?: string; sort?: string }
}) {
    const currentPage = parseInt(searchParams.page || '1')
    const sortBy = searchParams.sort || 'newest'
    // ...
}
```

**브라우저 히스토리:**

-   페이지네이션: `push` (뒤로가기 지원)
-   정렬 변경: `replace` (히스토리 중복 방지)

### Testing

#### 단위 테스트

-   노트 목록 조회 함수 테스트
-   페이지네이션 로직 테스트
-   정렬 함수 테스트

#### 통합 테스트

-   노트 목록 페이지 렌더링
-   페이지네이션 동작
-   정렬 기능 동작

#### E2E 테스트

-   노트 목록 → 상세 페이지 네비게이션
-   페이지네이션 사용자 플로우
-   정렬 변경 플로우

### 프로젝트 구조

**새로 추가될 파일:**

-   `components/ui/pagination.tsx` - 페이지네이션 컴포넌트
-   `components/ui/select.tsx` - 선택 드롭다운 컴포넌트
-   `components/ui/skeleton.tsx` - 로딩 스켈레톤
-   `components/notes/note-card.tsx` - 노트 카드 컴포넌트
-   `components/notes/notes-grid.tsx` - 노트 그리드 컨테이너
-   `components/notes/notes-sort.tsx` - 정렬 컴포넌트
-   `app/notes/[id]/page.tsx` - 노트 상세 페이지 (기본 구조)
-   `lib/notes/utils.ts` - 노트 관련 유틸리티 함수

**수정될 파일:**

-   `app/notes/page.tsx` - 페이지네이션 및 정렬 기능 추가
-   `lib/notes/queries.ts` - 페이지네이션 및 정렬 파라미터 추가

## Change Log

| Date       | Version | Description                            | Author           |
| ---------- | ------- | -------------------------------------- | ---------------- |
| 2025-09-14 | 1.0     | 스토리 생성                            | Dev Agent Claude |
| 2025-09-14 | 1.1     | 구현 완료 및 Dev Agent Record 업데이트 | Dev Agent GPT-5  |

## Dev Agent Record

이 섹션은 개발 에이전트가 구현 중에 채워집니다.

### Agent Model Used

GPT-5 (Cursor Dev Agent)

### Debug Log References

-   Next.js Dynamic APIs 경고 해결
    -   Route "/notes" used `searchParams.page` / `searchParams.sort` → Server Component에서 `searchParams`를 Promise로 받고 `await`하도록 수정
    -   Route "/notes/[id]" used `params.id` → Server Component에서 `params`를 Promise로 받고 `await`하도록 수정
-   TypeScript 경로 alias 이슈 해결
    -   `@/lib/notes/utils`, `@/components/notes/notes-sort` 모듈 미인식 → `tsconfig.json`에 `baseUrl: "."` 추가

### Completion Notes List

-   서버 사이드 페이지네이션/정렬 구현 및 총 개수 반환
-   정렬 드롭다운(`NotesSortControl`)에서 `replace`로 히스토리 중복 방지, 정렬 변경 시 페이지 1로 이동
-   로딩 스켈레톤 추가로 초기 로드 UX 개선
-   본문 미리보기(150자), 상대시간 표기 유틸 적용
-   노트 카드 → 상세 페이지 네비게이션 구현(`/notes/[id]`)
-   반응형 그리드(1/2/3열) 및 접근성 기본 고려

### File List

-   Modified: `lib/notes/queries.ts` (페이지네이션/정렬/카운트)
-   Modified: `app/notes/page.tsx` (URL 파라미터 처리, 페이지네이션/정렬 UI, 네비게이션)
-   Added: `components/notes/notes-sort.tsx`
-   Added: `components/ui/skeleton.tsx`
-   Added: `lib/notes/utils.ts`
-   Added: `app/notes/loading.tsx`
-   Added: `app/notes/[id]/page.tsx`
-   Modified: `tsconfig.json` (baseUrl)
-   Modified: `.cursor/project-rule.mdc` (Next.js 비동기 규칙 추가)
-   Modified: `docs/stories/2.2.story.md` (상태 및 체크리스트 갱신)

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
